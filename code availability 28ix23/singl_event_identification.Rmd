---
title: "diurnal temp and heat alert"
output: html_document
date: "2022-10-14"
---

```{r setup working directory and pacakages}
knitr::opts_knit$set(root.dir = "D:/DiXi/environmental metric/exposure rds/real id")
#setwd("D:/DiXi/environmental metric") -> the working directory will be reset when the chunk is finished.


library(data.table)
library(tidyverse)
library(dplyr)
library(readr)
library(lubridate) # date
library(doBy)

## file path
path = "D:/DiXi/environmental metric/exposure rds/real id"

```

```{r load data}
# entry_2000 = readRDS('entry_2000_id.rds')
entry_2008_id = readRDS('entry_2008_id.rds')

```

```{r create a test set}
#testset = entry_2008_id[which(year(entry_2008_id$date) == 2010 & month(entry_2008_id$date) == 7),]
#saveRDS(testset, 'subset_to_test.rds')

setwd(path)
testset = readRDS('subset_to_test.rds')
```

#### ================== Diurnal Temperature  range ====================  ####
Diurnal temperature range is the difference between daily maximum and minimum air temperature
```{r define a function to calculate diurnal temperature}
# input: a dataframe - environmental metrics
# output: a dataframe 
getDiurnal = function(df){
  
  df$diurnal_air_temp = df$air_temp_max - df$air_temp_min
  
  # return the dataframe
  df
}

# get the diurnal temperature of the test dataset/ each wave
testset = getDiurnal(testset) # 
```


#### ================== Heat wave ====================  ####
```{r identify heat wave days for each participant}
getHW = function(df){
  
    # order by id and then date --> find consecutive days
    df = orderBy(~id + date, data = df)
    
    
    #### -------find 92 percentile for each participant during the study period ------####
    df %>% group_by(id) %>% summarize(p92 = quantile(air_temp_max, 0.92, na.rm = TRUE)) -> p92
    df = left_join(df, p92, by = c('id'))
    
    # define a threshold(hwt): if air_temp_max>p92, hwt = 1; otherwise=0
    df$hwt = 0
    df$hwt[which((df$air_temp_max - df$p92) >= 0)] = 1
    
    # use rle function to get consecutive numbers: (1,>=3 days)
    runs = rle(df$hwt)
    myruns = which(runs$values == 1 & runs$lengths >= 3)
    
    # get the index of of [start, end] for each heat wave
    runs.lengths.cumsum = cumsum(runs$lengths) # cumulative sum of the run length and extract the position of the runs
    ends = runs.lengths.cumsum[myruns]
    
    newindex = ifelse(myruns > 1, myruns-1, 0)
    starts = runs.lengths.cumsum[newindex] + 1
    if (0 %in% newindex) starts = c(1, starts)
    
    
    ####--------  heat wave indicator -------####
    # heatwave day indicator: 1-> heatwave occurs
    df$hwd.ind = 0
    
    # find the index of heat wave days
    ls.index = c(starts[1]: ends[1]); l2 = c(starts[2]: ends[2])
    
    for (i in 2:length(myruns)) {
      ls.index = append(ls.index, c(starts[i]: ends[i]))
    }
    
    # heatwave day indicator(hwd.ind) = 1 when heat wave occur; otherwise 0
    df$hwd.ind[ls.index] = 1
    

    ####--------  heat wave characteristics -------####
    ## HWD: heawave duration - the length of the longest heatwave event
    ## HWA: heatwave amplitude - the higest value of the heatwave in a season
    ## HWM: the mean magnitudes (average magnitude across all heatwaves)
    
    
    # df$hwd.starts = 0
    # df$hwd.starts[starts] = 1
    # 
    # df$hwd.dur = 0
    # duration = ends - starts + 1 # durations of all heatwave events among all participants
    # df$hwd.dur[starts] = duration # notify the duration of heat wave at the start day of the heatwave
    # 
    # df[which(df$hwd.ind == 1), ] %>% group_by(NEWID) %>% summarise(HWF = sum(hwd.ind),
    #                                                                       HWD = max(hwd.dur),
    #                                                                       HWN = sum(hwd.starts),
    #                                                                       HWA = max(air_temp_max),
    #                                                                       HWM = mean(air_temp_max)) ->sub.hw
    # 
    #----------- remove hwt------------#
    df <- df[,!names(df) %in% c('p92', 'hwt')]
    
    
    #### return df: with indicator of heat wave day

    df
    
 
}


testset = getHW(testset) 

```






```{r - heat alert in color system}
# yellow: max air temp above 35 for 3 consecutive  days
# orange: 24h maximum > 37
# red:    24h maximum > 40
# green(self-defined): non-heat alert

getHeatColor = function(df){
    
    df$heat_alert_color = NA
    
    
    ######## ------------------identify yellow alert -----------------------#####
    df$thres35c = 0 # whether temp > 35, if so -> 1; otherwise 0
    df$thres35c[which(df$air_temp_max >= 35)] = 1
    
    # use rle function to get consecutive numbers 
    runs = rle(df$thres35c)
    myruns = which(runs$values == 1 & runs$lengths >= 3)
    
    # do a cumulative sum of the run lengths and extract the positions
    runs.lengths.cumsum = cumsum(runs$lengths)
    ends = runs.lengths.cumsum[myruns]
    
    # next, we find the start positions of these runs
    newindex = ifelse(myruns > 1, myruns-1, 0)
    starts = runs.lengths.cumsum[newindex] + 1
    if (0 %in% newindex) starts = c(1, starts)
    
    # find the index of yellow alert
    yellow.index = c(starts[1]: ends[1])
    
    for (i in 2:length(myruns)) {
      yellow.index = append(yellow.index, c(starts[i]: ends[i]))
    }
    
    # heat_alert_color = yellow
    df$heat_alert_color[yellow.index] = 'yellow'
    
    
    
    ######## ------------------identify orange and red alert -----------------------#####
    df$heat_alert_color[which(df$air_temp_max >= 37)] = 'orange'
    df$heat_alert_color[which(df$air_temp_max >= 40)] = 'red'

    
    
    ## --- check distribution --- ##
    #table(df$heat_alert_color)
    
    ##remove thres35
    df <- df[,!names(df) %in% c('thres35c')]
    
    ## ------- return df ###
    df


    }



testset = getHeatColor(testset) 




```



#### ======================= Scale the wind speed ========================= ####
```{r scale the wind speed using Beaufort Scale}

getWindScale = function(df, ws){
  
      #ws: extract max wind speed or mean wind speed
      #df: the dataframe
  
      df$wind_scale = NA
      
      # extract the wind speed column
      windscale = df[, c(ws)]
      
      df$wind_scale[which(windscale>=0 & windscale <0.3)] = 0
      df$wind_scale[which(windscale>=0.3 & windscale <1.6)] = 1
      df$wind_scale[which(windscale>=1.6 & windscale <3.4)] = 2
      df$wind_scale[which(windscale>=3.4 & windscale <5.5)] = 3
      df$wind_scale[which(windscale>=5.5 & windscale <8.0)] = 4
      df$wind_scale[which(windscale>=8.0 & windscale <10.8)] = 5
      df$wind_scale[which(windscale>=10.8 & windscale <13.9)] = 6
      df$wind_scale[which(windscale>=13.9 & windscale <17.2)] = 7
      df$wind_scale[which(windscale>=17.2 & windscale <20.8)] = 8
      df$wind_scale[which(windscale>=20.8 & windscale <24.5)] = 9
      df$wind_scale[which(windscale>=24.5 & windscale <28.5)] = 10
      df$wind_scale[which(windscale>=28.5 & windscale <32.7)] = 11
      df$wind_scale[which(windscale>=32.7 & windscale <37.0)] = 12
      df$wind_scale[which(windscale>=37.0 & windscale <41.5)] = 13
      df$wind_scale[which(windscale>=41.5 & windscale <46.2)] = 14
      df$wind_scale[which(windscale>=46.2 & windscale <51.0)] = 15
      df$wind_scale[which(windscale>=51.0 & windscale <56.1)] = 16
      df$wind_scale[which(windscale>=56.1 & windscale <61.3)] = 17
      df$wind_scale[which(windscale>=61.3)] = 18
      
      
      
      ## ------- return dataframe -------##
      df
  
}



# max wind scale during a day
testset = getWindScale(testset, 'wind_speed_10m_max'); setnames(testset,"wind_scale","max_wind_scale")

# mean wind scale during a day
testset$mean_wind_scale = getWindScale(testset, 'wind_speed_10m_mean')[, c('wind_scale')]

```

## ========================== storm alert in color system ======================== ##

```{r storm alert in color system}
## blue:    avg wind scale 6-7   or  max wind level 7-8
## yellow:  avg wind scale 8-9   or  max wind scale 9-10
## orange:  avg wind scale 10-11 or  max wind scale 11-12
## red:     avg wind scale >= 12 or  max wind scale >= 13

getStormAlert = function(df){
  
      df$storm_alert = NA
      
      df$storm_alert[which(df$mean_wind_scale == c(6,7) | df$max_wind_scale == c(7,8))] = 'blue'

      df$storm_alert[which(df$mean_wind_scale == c(8,9) | df$max_wind_scale == c(9,10))] = 'yellow'
      
      df$storm_alert[which(df$mean_wind_scale == c(10,11) | df$max_wind_scale == c(11,12))] = 'orange'
      
      df$storm_alert[which(df$mean_wind_scale >= 12 | df$max_wind_scale >=13)] = 'red'
      
      
      ## ----- return ------##
      df
}


testset = getStormAlert(testset)
table(testset$storm_alert)


```


## ================================ snow ================================== ##
```{r snow alert in color system}
## blue:    >=4 mm
## yellow:  >=6 mm
## orange:  >= 10mm
## red:     >= 15mm

getSnowAlert = function(df){
  
      df$snow_alert = NA
      
      df$snow_alert[which(df$snowfall >=4 & df$snowfall <6 )] = 'blue'

      df$snow_alert[which(df$snowfall >=6 & df$snowfall <10)] = 'yellow'
      
      df$snow_alert[which(df$snowfall >=10 & df$snowfall <15)] = 'orange'
      
      df$snow_alert[which(df$snowfall >=15)] = 'red'
      
      
      ## ----- return ------##
      df
}



```


## ================================ rainfall ================================== ##
```{r rain alert in color system}
## blue:    >=50 mm in 12 hours
## yellow:  >50 mm in 6 hours
## orange:  >= 50 mm in 3 hours
## red:     >= 100mm

getRainAlert = function(df){
  
      df$rain_alert = NA
      
      df$rain_alert[which(df$rainfall >=50 & df$rainfall <100 )] = 'blue/yellow/orange'
      
      df$rain_alert[which(df$rainfall >=100)] = 'red'
      
      
      ## ----- return ------##
      df
}



```


## ================================ frost ================================= ##
```{r forst alert in color system}
## blue:   land surface temperature < 0
## yellow: land surface temperature < -3
## orange: land surface temperature < -5

getFrost = function(df){
  
      df$frost_alert = NA
      
      df$frost_alert[which(df$sur_temp_min <= 0)] = 'blue'
      df$frost_alert[which(df$sur_temp_min <= -3)] = 'yellow'
      df$frost_alert[which(df$sur_temp_min <= -5)] = 'orange'
  
      ## ---- return ----##
      return(df)
}

testset = getFrost(testset)
table(testset$frost_alert)
```





## ================================= remove save rds ======================= ##
```{r}
saveRDS(testset, 'testset_color.rds')

```



##############################################################################################
################## operate functions on real world data ######################################
##############################################################################################

```{r environmental metrics for 2008 wave}
#colnames(entry_2008_id)[which(names(entry_2008_id) == "mean")] = "total_precipitation"
#head(entry_2008_id)

#envi.2008 = getDiurnal(entry_2008_id)
envi.2008 = getHW(envi.2008)
envi.2008 = getHeatColor(envi.2008)

# windscale
#envi.2008 = getWindScale(envi.2008, 'wind_speed_10m_max');
#setnames(envi.2008,"wind_scale","max_wind_scale")

#envi.2008$mean_wind_scale = getWindScale(envi.2008, 'wind_speed_10m_mean')[, c('wind_scale')]

#envi.2008 = getStormAlert(envi.2008)
#envi.2008 = getFrost(envi.2008)


table(envi.2008$hwd.ind)
table(envi.2008$heat_alert_color)


saveRDS(envi.2008, 'envi_2008.rds')
```




