---
title: "saveCSV"
author: "Di"
date: "2023-06-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r read all definition}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling'

file_names <- list.files(directory_path, pattern = ".rds", full.names = TRUE)  # Get the list of RDS file names

hw_list <- list()  # Create an empty list to store the dataframes

for (file_name in file_names) {
  data_frame <- readRDS(file_name)  # Read each RDS file
  hw_list[[file_name]] <- data_frame
}


```


```{r test get result}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\iadl' # Replace with the directory path containing RDS files

file_names <- list.files(directory_path, pattern = ".rds", full.names = TRUE)  # Get the list of RDS file names

dataframes_list <- list()  # Create an empty list to store the dataframes

for (file_name in file_names) {
  data_frame <- readRDS(file_name)  # Read each RDS file

  def <- str_extract_all(file_name, "HW\\d+")
  
  for (i in seq_along(data_frame)) {
    df <- data_frame[[i]]
    colnames(df) <- c("term", "estimate", "std.error", "robust.se", "statistic", "p.value", "conf.low", "conf.high")
    
    csv_name <- paste0(def, '_', names(data_frame)[i], ".csv")
    
    df <- df %>% summarise(term = term,
                           HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'))

    #save csv
    file_path <- file.path(directory_path, csv_name)
    
    write.csv(df, file_path, row.names = FALSE)
  }
  
  
}
```



```{r test combine result}
library(purrr)
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\iadl\\full function' # Replace with the directory path containing RDS files

file_names <- list.files(directory_path, pattern = ".csv", full.names = TRUE)  # Get the list of RDS file names
new_order = c(1,3,4,5,6,7,8,9,10,2)
file_names =file_names[new_order]

dataframes_list <- list()  # Create an empty list to store the dataframes

for (file_name in file_names) {
  data_frame <- read.csv(file_name)  # Read each RDS file

  def <- str_extract(file_name, "HW\\d+")
  colnames(data_frame) = c('term', paste0(def, '.HR'), paste0(def, '.p'))
  
  
  dataframes_list[[basename(file_name)]] = data_frame

}

merged_df <- reduce(dataframes_list, merge, by = "term")
#save csv
csv_name = 'iadl_full_function.csv'
file_path <- file.path(directory_path, csv_name)

write.csv(merged_df, file_path, row.names = FALSE)
```



```{r function getcsv}

getCSV = function(directory_path){
  
    file_names <- list.files(directory_path, pattern = ".rds", full.names = TRUE)  # Get the list of RDS file names

    dataframes_list <- list()  # Create an empty list to store the dataframes
    
    for (file_name in file_names) {
      data_frame <- readRDS(file_name)  # Read each RDS file
    
      def <- str_extract_all(file_name, "HW\\d+")
      
    for (i in seq_along(data_frame)) {
      df <- data_frame[[i]]
      colnames(df) <- c("term", "estimate", "std.error", "robust.se", "statistic", "p.value", "conf.low", "conf.high")
      
      csv_name <- paste0(def, '_', names(data_frame)[i], ".csv")
      
      df <- df %>% summarise(term = term,
                             HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                             p = round(p.value,4))
      
      file_path <- file.path(directory_path, csv_name)
      
      write.csv(df, file_path, row.names = FALSE)
    }
}
}



```

```{r function combine result}

#subpath = '/full function'

combineResults = function(directory_path, subpath, csv_name){
      library(purrr)
      path = paste0(directory_path, subpath)
      
      file_names <- list.files(path, pattern = ".csv", full.names = TRUE)  # Get the list of RDS file names
      new_order = c(1,3,4,5,6,7,8,9,10,2)
      file_names =file_names[new_order]
      
      dataframes_list <- list()  # Create an empty list to store the dataframes
      
      for (file_name in file_names) {
        data_frame <- read.csv(file_name)  # Read each RDS file
      
        def <- str_extract(file_name, "HW\\d+")
        colnames(data_frame) = c('term', paste0(def, '.HR'), paste0(def, '.p'))
        
        
        dataframes_list[[basename(file_name)]] = data_frame
      
      }
      
      merged_df <- reduce(dataframes_list, merge, by = "term")
      #save csv
      #csv_name = 'iadl_full_function.csv'
      file_path <- file.path(path, csv_name)
      
      write.csv(merged_df, file_path, row.names = FALSE)
}


directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\iadl' # Replace with the directory path containing RDS files
    
combineResults(directory_path, '/full function',' iadl_full_function.csv')
combineResults(directory_path, '/moderate impairment',' iadl_moderate_impairment.csv')
combineResults(directory_path, '/severe impairment',' iadl_severe_impairment.csv')
```

