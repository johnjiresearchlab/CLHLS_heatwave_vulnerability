---
title: "fully adjusted model and forest plot"
author: "Di"
date: "2023-06-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\fully adjusted result')


knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(survival)
library(forestplot)
library(grid)
library(checkmate)
library(abind)
library(broom)
library(ggplot2)

```



```{r fully adjusted model}
getFullyAdjusted = function(dataset, file_name){

  
    mod = coxph(Surv(tstart, times, event.death) ~ 
                            # exposure and environmental covariates
                            hwd.ind + pm25.scale + ndvi.scale + rh.scale +
                            # demographical factors
                            trueage + sex + UorR + co.resi.baseline + education + occupation + marital.baseline + 
                            # physical logical disorder and cognitive disorder
                            adl.status + mmse.status.baseline + iadl.status +
                            # mental health and personality
                            life.sat.score + personality.score+
                            # life style
                            fruit + veg + tea + d71 + d81 + d91 + 
                            # social participation and network #low.invol.act + 
                            high.invol.act + network.interact +
                            #strata(region) + cluster(clusters),
                            strata(region) + cluster(id),
                          
                          
                    data = dataset)

    mod %>% tidy(conf.int = TRUE, exponentiate = TRUE) %>% 
            subset(! term %in% c('d71missing', 'd81missing', 'd91missing', 'co.resi.baselinemissing','d91don\'t know'))%>%
            mutate(term = ifelse(term == "d71no", "smokingno",
                          ifelse(term == "d81no", "drinkingno",
                                  ifelse(term == "d91no", "exerciseno", term))))-> result
    
    # save result
    saveRDS(result, file_name)
    
    return(result)

}

#result = getFullyAdjusted(HW6_WMO_95th_2D_updated0615, 'HW6_fully_adjusted.rds')
#result
```

```{r get forest plot}

getForest = function(tidy_result, title_surfix){
    
   tidy_result %>% subset(! term %in% c('pm25.scale', 'rh.scale', 'ndvi.scale', 'NA'))-> tidy_result
   
   # reorder term    
   term_order = c('hwd.ind', 
                  'trueage', 'sexfemale', 'UorRurban', 'co.resi.baselinealone', 'co.resi.baselinein an institution', 
                  'education1-6 years', 'education7 years or above', 'occupationcommercial, service or industrial worker or self-employer',
                  'occupationhouseworker, never worked, other', 'occupationprofessional, governmental or managerial personnel',
                  'marital.baselinewithout a spouse',
                  'adl.statusmoderate ADL impairment', 'adl.statussevere ADL impairment', 'iadl.statusmoderate IADL impairment','iadl.statussevere IADL impairment',
                  'mmse.status.baselinepoor cognitive function',
                  'fruityes', 'vegyes', 'teayes', 'smokingno', 'drinkingno', 'exerciseno',
                  'life.sat.score', 'personality.score',
                  'high.invol.act', 'network.interactmainly interact with strong social ties', 'network.interactmainly interact with weak social ties')
   term_order <- rev(term_order)
   tidy_result$term = factor(tidy_result$term, levels = term_order)
  
  #create forest plot
  ggplot(tidy_result, aes(x=term, y=estimate)) +
         geom_errorbar(aes(ymin=conf.low, ymax=conf.high), 
                       width = 0.3,size  = 0.6,
                       position = "dodge", color="turquoise4") +
  geom_hline(yintercept = 1, color = "red", size = 0.5) +
  geom_point() + coord_flip() +
  labs(x = "individual characteristics", y = "Hazard Ratio", title = title_surfix) ->p
  
  return(p)
  
}

#forestplottest = getForest(result, 'HW6')
#forestplottest 
```


```{r generate tidy fully adjusted result and corresponding forestplot}
# hw1 = getFullyAdjusted(HW1_CMA_updated0615, 'HW1_fully_adjusted.rds');  p.hw1 = getForest(hw1, 'HW1');p.hw1
# hw2 = getFullyAdjusted(HW2_WMO_90th_1D_updated0615, 'HW2_fully_adjusted.rds');  p.hw2 = getForest(hw2, 'HW2');p.hw2
# hw3 = getFullyAdjusted(HW3_WMO_90th_2D_updated0615, 'HW3_fully_adjusted.rds');  p.hw3 = getForest(hw3, 'HW3');p.hw3
# hw4 = getFullyAdjusted(HW4_WMO_90th_3D_updated0615, 'HW4_fully_adjusted.rds');  p.hw4 = getForest(hw4, 'HW4');p.hw4
# hw5 = getFullyAdjusted(HW5_WMO_95th_1D_updated0615, 'HW5_fully_adjusted.rds');  p.hw5 = getForest(hw5, 'HW5');p.hw5
# hw6 = getFullyAdjusted(HW6_WMO_95th_2D_updated0615, 'HW6_fully_adjusted.rds');  p.hw6 = getForest(hw6, 'HW6');p.hw6
# hw7 = getFullyAdjusted(HW7_WMO_95th_3D_updated0615, 'HW7_fully_adjusted.rds');  p.hw7 = getForest(hw7, 'HW6');p.hw7
# hw8 = getFullyAdjusted(HW8_NOAA_10degree_1D_updated0615, 'HW8_fully_adjusted.rds');  p.hw8 = getForest(hw8, 'HW8');p.hw8
# hw9 = getFullyAdjusted(HW9_NOAA_10degree_2D_updated0615, 'HW9_fully_adjusted.rds');  p.hw9 = getForest(hw9, 'HW9');p.hw9
# hw10 = getFullyAdjusted(HW10_NOAA_10degree_3D_updated0615, 'HW10_fully_adjusted.rds');  p.hw10 = getForest(hw10, 'HW10');p.hw10

p.hw1 = getForest(hw1, 'HW1');p.hw1
p.hw2 = getForest(hw2, 'HW2');p.hw2
p.hw3 = getForest(hw3, 'HW3');p.hw3
p.hw4 = getForest(hw4, 'HW4');p.hw4
p.hw5 = getForest(hw5, 'HW5');p.hw5
p.hw6 = getForest(hw6, 'HW6');p.hw6
p.hw7 = getForest(hw7, 'HW7');p.hw7
p.hw8 = getForest(hw8, 'HW8');p.hw8
p.hw9 = getForest(hw9, 'HW9');p.hw9
p.hw10 = getForest(hw10, 'HW10');p.hw10
```







```{r subgroup analysis}
head(hw.dataset)
# Perform subgroup analysis
stratified_cox <- function(data, stratify_var) {
  stratify_levels <- unique(data[[stratify_var]])
  cox_models <- lapply(stratify_levels, function(stratify_val) {
    subset_data <- subset(data, data[[stratify_var]] == stratify_val)
    coxph(Surv(tstart, times, event.death) ~ hwd.ind + pm25.scale + ndvi.scale + rh.scale +
            trueage + sex + UorR + education + occupation + marital.baseline + adl.status + 
            mmse.status.baseline + iadl.status + life.sat.score + personality.score + fruit +
            veg + tea + d71 + d81 + d91 + low.invol.act + high.invol.act + network.interact +
            cluster(id), data = subset_data, ties = "breslow")
  })
  names(cox_models) <- stratify_levels
  cox_models
}

# Usage example
stratified_models <- stratified_cox(hw.dataset, "agegroup")
```






