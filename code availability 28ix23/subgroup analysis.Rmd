---
title: "subgroup analysis"
author: "Di"
date: "2023-06-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(root.dir = 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis')


knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(survival)
library(forestplot)
library(grid)
library(checkmate)
library(abind)
library(broom)
library(stringr)
```



```{r test}
df = HW6_WMO_95th_2D_updated0615
stratify_var = 'agegroup2'

  df$agegroup2 = NA
  df$agegroup2[which(df$trueage < 80)] = 'below 80'
  df$agegroup2[which(df$trueage >=80 & df$trueage < 100)] = '80_99'
  df$agegroup2[which(df$trueage >= 100)] = '100'
    

  stratify_levels <- as.character(na.omit(unique(df[[stratify_var]])))
  stratify_levels <- stratify_levels[!(stratify_levels %in% c("don't know", "missing"))]#; stratify_levels


    # List of covariates
    covariates <- c(#demographic
                    "trueage", "sex", "UorR", "co.resi.baseline","education", "occupation", "marital.baseline",
                    # physcialand mental disorder
                    "adl.status", "mmse.status.baseline", "iadl.status",
                    # section b
                    "life.sat.score", "personality.score",
                    # life style
                    "fruit", "veg", "tea", "d71", "d81", "d91",
                    # social
                    "high.invol.act", "network.interact"
                    )
    if (stratify_var == 'agegroup') {covariates <- covariates[!covariates %in% c("trueage","life.sat.score", "personality.score")]}
    if (stratify_var == 'agegroup2') {covariates <- covariates[!covariates %in% c("trueage","life.sat.score", "personality.score")]}
    
    results = list()
    for (level in stratify_levels) {
      
    # remove covariate for subgroup analsyis
    covariate_stratify = covariates[! covariates %in%  stratify_var]
    
    if (stratify_var == 'adl.status' & level == 'severe ADL impairment') {covariate_stratify <- covariate_stratify[covariate_stratify != "iadl.status"]}
    
    
    # construct formula
    covariates_string <- paste(covariate_stratify, collapse = " + ")
    
    if (str_detect("NOAA", deparse(substitute(df)))) {
        # Formula 1 for NOAA
        f <- paste0('Surv(tstart, times, event.death) ~ hwd.ind + pm25.scale + ndvi.scale +', covariates_string, '+ strata(region) + cluster(id)')
      } else {
        # Formula 2 for other cases
        f <- paste0('Surv(tstart, times, event.death) ~ hwd.ind + pm25.scale + ndvi.scale + rh.scale +', covariates_string, '+ strata(region) + cluster(id)')
      }
      
      
      subset_data <- subset(df, df[[stratify_var]] == level)
    
      # Fit the Cox model
      f = as.formula(f)
      coxfit <- coxph(f, data = subset_data)
    
      # Store the model results
      result <- coxfit %>% tidy(conf.int = TRUE, exponentiate = TRUE)
      
      results[[level]] <- result
    }
    
     #saveRDS(results, 'test_subgroup.rds')
```




```{r}
getSubGroup = function(df, stratify_var, def){

    
  stratify_levels <- as.character(na.omit(unique(df[[stratify_var]])))
  stratify_levels <- stratify_levels[!(stratify_levels %in% c("don't know", "missing"))]#; stratify_levels


    # List of covariates
    covariates <- c(#demographic
                    "trueage", "sex", "UorR", "co.resi.baseline","education", "occupation", "marital.baseline",
                    # physcialand mental disorder
                    "adl.status", "mmse.status.baseline", "iadl.status",
                    # section b
                    "life.sat.score", "personality.score",
                    # life style
                    "fruit", "veg", "tea", "d71", "d81", "d91",
                    # social
                    "high.invol.act", "network.interact"
                    )
    if (stratify_var == 'agegroup') {covariates <- covariates[!covariates %in% c("trueage","life.sat.score", "personality.score")]}
    if (stratify_var == 'satisfaction_tertiles') {covariates <- covariates[!covariates %in% c("life.sat.score")]}
    if (stratify_var == 'personality_tertiles') {covariates <- covariates[!covariates %in% c("personality.score")]}
    if (stratify_var == 'involvment_tertiles') {covariates <- covariates[!covariates %in% c("high.invol.act",'network.interact')]}
    if (stratify_var == 'network.interact') {covariates <- covariates[!covariates %in% c("high.invol.act")]}
    
    covariate_stratify = covariates[! covariates %in%  stratify_var]
    
    results = list()
    for (level in stratify_levels) {
      
    # remove covariate for subgroup analsyis
    
    
    if (stratify_var == 'adl.status' & level == 'severe ADL impairment') {covariate_stratify <- covariate_stratify[covariate_stratify != "iadl.status"]}
      
    if (stratify_var == 'network.interact' & level == 'mainly interact with nobody') {
                                  covariate_stratify <- covariate_stratify[!covariate_stratify %in% c("iadl.status", "personality.score", 'life.sat.score',
                                                                                                      'high.invol.act', 'fruit')]}
      
    # construct formula
    covariates_string <- paste(covariate_stratify, collapse = " + ")
    
    if (str_detect("NOAA", deparse(substitute(df)))) {
        # Formula 1 for NOAA
        f <- paste0('Surv(tstart, times, event.death) ~ hwd.ind + pm25.scale + ndvi.scale +', covariates_string, '+ strata(region) + cluster(id)')
      } else {
        # Formula 2 for other cases
        f <- paste0('Surv(tstart, times, event.death) ~ hwd.ind + pm25.scale + ndvi.scale + rh.scale +', covariates_string, '+ strata(region) + cluster(id)')
      }
      
      
      subset_data <- subset(df, df[[stratify_var]] == level)
    
      # Fit the Cox model
      f = as.formula(f)
      coxfit <- coxph(f, data = subset_data)
    
      # Store the model results
      result <- coxfit %>% tidy(conf.int = TRUE, exponentiate = TRUE)
      
      results[[level]] <- result
    }
    
    saveRDS(results, paste0(def, '_', stratify_var, '.rds'))
    

    
    return(results)
}
```



```{r SEX}
directory_path <-'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\sex'

setwd(directory_path)
# getSubGroup(HW1_CMA_updated0615, 'sex', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'sex', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'sex', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'sex', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'sex', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'sex', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'sex', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'sex', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'sex', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'sex', 'HW10')

getCSV(directory_path)
combineResults(directory_path, '/male','male.csv')
combineResults(directory_path, '/female','female.csv')
```


```{r UorR}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\UorR'
setwd(directory_path)
# getSubGroup(HW1_CMA_updated0615, 'UorR', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'UorR', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'UorR', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'UorR', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'UorR', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'UorR', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'UorR', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'UorR', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'UorR', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'UorR', 'HW10')


getCSV(directory_path)
combineResults(directory_path, '/urban','urban.csv')
combineResults(directory_path, '/rural','rural.csv')
```

```{r education}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\education'
setwd(directory_path)

# getSubGroup(HW1_CMA_updated0615, 'education', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'education', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'education', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'education', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'education', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'education', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'education', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'education', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'education', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'education', 'HW10')

getCSV(directory_path)
combineResults(directory_path, '/year0','year0.csv')
combineResults(directory_path, '/year6','year6.csv')
combineResults(directory_path, '/year7','year7.csv')

```

```{r occupation}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\occupation'
setwd(directory_path)

# changeOccu = function(df){
#   
#   df[, -which(names(df) == 'occupation')] %>% left_join(occu, by = 'id') -> df
#   
#   return(df)
#   
# }
# changeOccu(HW1_CMA_updated0615) -> HW1_CMA_updated0615


getSubGroup(HW1_CMA_updated0615, 'occupation', 'HW1')
getSubGroup(HW2_WMO_90th_1D_updated0615, 'occupation', 'HW2')
getSubGroup(HW3_WMO_90th_2D_updated0615, 'occupation', 'HW3')
getSubGroup(HW4_WMO_90th_3D_updated0615, 'occupation', 'HW4')
getSubGroup(HW5_WMO_95th_1D_updated0615, 'occupation', 'HW5')
getSubGroup(HW6_WMO_95th_2D_updated0615, 'occupation', 'HW6')
getSubGroup(HW7_WMO_95th_3D_updated0615, 'occupation', 'HW7')
getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'occupation', 'HW8')
getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'occupation', 'HW9')
getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'occupation', 'HW10')


getCSV(directory_path)
combineResults(directory_path, '/agriculture','agriculture.csv')
combineResults(directory_path, '/commercial','commercial.csv')
combineResults(directory_path, '/professional','professional.csv')
combineResults(directory_path, '/never work','never work.csv')
```


```{r marital stauts}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\marital status'
setwd(directory_path)

# getSubGroup(HW1_CMA_updated0615, 'marital.baseline', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'marital.baseline', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'marital.baseline', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'marital.baseline', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'marital.baseline', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'marital.baseline', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'marital.baseline', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'marital.baseline', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'marital.baseline', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'marital.baseline', 'HW10')


#getCSV(directory_path)
combineResults(directory_path, '/married','married.csv')
combineResults(directory_path, '/no spouse','nospouse.csv')
```



```{r adl}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\adl'

setwd(directory_path)


# getSubGroup(HW1_CMA_updated0615, 'adl.status', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'adl.status', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'adl.status', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'adl.status', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'adl.status', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'adl.status', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'adl.status', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'adl.status', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'adl.status', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'adl.status', 'HW10')

# export csv
getCSV(directory_path)
combineResults(directory_path, '/full function',' adl_full_function.csv')
combineResults(directory_path, '/moderate impairment',' adl_moderate_impairment.csv')
combineResults(directory_path, '/severe impairment',' adl_severe_impairment.csv')
```

```{r iadl}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\iadl'

setwd(directory_path)
# getSubGroup(HW1_CMA_updated0615, 'iadl.status', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'iadl.status', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'iadl.status', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'iadl.status', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'iadl.status', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'iadl.status', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'iadl.status', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'iadl.status', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'iadl.status', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'iadl.status', 'HW10')

# export csv
getCSV(directory_path)
combineResults(directory_path, '/full function',' iadl_full_function.csv')
combineResults(directory_path, '/moderate impairment',' iadl_moderate_impairment.csv')
combineResults(directory_path, '/severe impairment',' iadl_severe_impairment.csv')
```


```{r mmse}
directory_path <-'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\mmse'
setwd(directory_path)

# getSubGroup(HW1_CMA_updated0615, 'mmse.status.baseline', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'mmse.status.baseline', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'mmse.status.baseline', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'mmse.status.baseline', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'mmse.status.baseline', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'mmse.status.baseline', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'mmse.status.baseline', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'mmse.status.baseline', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'mmse.status.baseline', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'mmse.status.baseline', 'HW10')

# export csv
getCSV(directory_path)
combineResults(directory_path, '/normal','normal_mmse.csv')
combineResults(directory_path, '/poor','poor_mmse.csv')
```






```{r tea}
directory_path <-'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\tea'
setwd(directory_path)

# getSubGroup(HW1_CMA_updated0615, 'tea', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'tea', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'tea', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'tea', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'tea', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'tea', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'tea', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'tea', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'tea', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'tea', 'HW10')

# export csv
#getCSV(directory_path)
combineResults(directory_path, '/yes','tea_yes.csv')
combineResults(directory_path, '/no','tea_no.csv')
```





```{r fruit}
directory_path <-'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\fruit'
setwd(directory_path)

# getSubGroup(HW1_CMA_updated0615, 'fruit', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'fruit', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'fruit', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'fruit', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'fruit', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'fruit', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'fruit', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'fruit', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'fruit', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'fruit', 'HW10')

# export csv
#getCSV(directory_path)
combineResults(directory_path, '/yes','fruit_yes.csv')
combineResults(directory_path, '/no','fruit_no.csv')
```



```{r veg}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\veg'
setwd(directory_path)

# getSubGroup(HW1_CMA_updated0615, 'veg', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'veg', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'veg', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'veg', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'veg', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'veg', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'veg', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'veg', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'veg', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'veg', 'HW10')

# export csv
# getCSV(directory_path)
combineResults(directory_path, '/yes','veg_yes.csv')
combineResults(directory_path, '/no','veg_no.csv')
```


```{r smoking}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\smoking'
setwd(directory_path)

# getSubGroup(HW1_CMA_updated0615, 'd71', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'd71', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'd71', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'd71', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'd71', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'd71', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'd71', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'd71', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'd71', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'd71', 'HW10')

# export csv
#getCSV(directory_path)
combineResults(directory_path, '/yes','smoking_yes.csv')
combineResults(directory_path, '/no','smoking_no.csv')
```



```{r drinking}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\drinking'
setwd(directory_path)

# getSubGroup(HW1_CMA_updated0615, 'd81', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'd81', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'd81', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'd81', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'd81', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'd81', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'd81', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'd81', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'd81', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'd81', 'HW10')

# export csv
#getCSV(directory_path)
combineResults(directory_path, '/yes','drinking_yes.csv')
combineResults(directory_path, '/no','drinking_no.csv')
```



```{r exercise}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\exercise'
setwd(directory_path)

# getSubGroup(HW1_CMA_updated0615, 'd91', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'd91', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'd91', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'd91', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'd91', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'd91', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'd91', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'd91', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'd91', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'd91', 'HW10')

# export csv
#getCSV(directory_path)
combineResults(directory_path, '/yes','exercise_yes.csv')
combineResults(directory_path, '/no','exercise_no.csv')
```





```{r coresidence}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\coresidence'
setwd(directory_path)


getCoresi = function(df, stratify_var, level, def){
    # List of covariates
    covariates <- c(#demographic
                    "trueage", "sex", "UorR", "education", "occupation", "marital.baseline",
                    # physcialand mental disorder
                    "adl.status", "mmse.status.baseline", "iadl.status",
                    # section b
                    "life.sat.score", "personality.score",
                    # life style
                    "fruit", "veg", "tea", "d71", "d81", "d91",
                    # social
                    "high.invol.act", "network.interact"
                    )
    covariate_stratify = covariates[! covariates %in% stratify_var]
    
    #results = list()
    # remove covariate for subgroup analsyis
    if (level == 'alone') {covariate_stratify <- covariate_stratify[!covariate_stratify %in% c("iadl.status")]}
    if (level == 'in an institution') { covariate_stratify <-  c("trueage", "sex") }
         
    # construct formula
    covariates_string <- paste(covariate_stratify, collapse = " + ")
    
    if (str_detect("NOAA", deparse(substitute(df)))) {
        # Formula 1 for NOAA
        f <- paste0('Surv(tstart, times, event.death) ~ hwd.ind +', covariates_string, '+ strata(region) + cluster(id)')
      } else {
        # Formula 2 for other cases
        f <- paste0('Surv(tstart, times, event.death) ~ hwd.ind +', covariates_string, '+ strata(region) + cluster(id)')
      }
      
      
      subset_data <- subset(df, df[[stratify_var]] == level)
    
      # Fit the Cox model
      f = as.formula(f)
      coxfit <- coxph(f, data = subset_data)
    
      # Store the model results
      result <- coxfit %>% tidy(conf.int = TRUE, exponentiate = TRUE)
      
      #results[[level]] <- result
    
    
    saveRDS(result, paste0(def, '_', level, '.rds'))
 
 
      csv_name <- paste0(def, '_', level, ".csv")
      
      df <- result %>% summarise(term = term,
                             HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                             p = round(p.value,4))
      
      file_path <- file.path(directory_path, csv_name)
      
      write.csv(df, file_path, row.names = FALSE)
}

# with household members
#  getCoresi(HW1_CMA_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW1')
# getCoresi(HW2_WMO_90th_1D_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW2')
# getCoresi(HW3_WMO_90th_2D_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW3')
# getCoresi(HW4_WMO_90th_3D_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW4')
# getCoresi(HW5_WMO_95th_1D_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW5')
# getCoresi(HW6_WMO_95th_2D_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW6')
# getCoresi(HW7_WMO_95th_3D_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW7')
# getCoresi(HW8_NOAA_10degree_1D_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW8')
# getCoresi(HW9_NOAA_10degree_2D_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW9')
# getCoresi(HW10_NOAA_10degree_3D_updated0615, 'co.resi.baseline', 'with household member(s)', 'HW10')
# 
# # live alone
# setwd(directory_path)
# getCoresi(HW1_CMA_updated0615, 'co.resi.baseline', 'alone', 'HW1')
# getCoresi(HW2_WMO_90th_1D_updated0615, 'co.resi.baseline', 'alone', 'HW2')
# getCoresi(HW3_WMO_90th_2D_updated0615, 'co.resi.baseline', 'alone', 'HW3')
# getCoresi(HW4_WMO_90th_3D_updated0615, 'co.resi.baseline', 'alone', 'HW4')
# getCoresi(HW5_WMO_95th_1D_updated0615, 'co.resi.baseline', 'alone', 'HW5')
# getCoresi(HW6_WMO_95th_2D_updated0615, 'co.resi.baseline', 'alone', 'HW6')
# getCoresi(HW7_WMO_95th_3D_updated0615, 'co.resi.baseline', 'alone', 'HW7')
# getCoresi(HW8_NOAA_10degree_1D_updated0615, 'co.resi.baseline', 'alone', 'HW8')
# getCoresi(HW9_NOAA_10degree_2D_updated0615, 'co.resi.baseline', 'alone', 'HW9')
# getCoresi(HW10_NOAA_10degree_3D_updated0615, 'co.resi.baseline', 'alone', 'HW10')




# live in an institution
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\institution - age sex'
setwd(directory_path)
getCoresi(HW1_CMA_updated0615, 'co.resi.baseline', 'in an institution', 'HW1')
getCoresi(HW2_WMO_90th_1D_updated0615, 'co.resi.baseline', 'in an institution', 'HW2')
getCoresi(HW3_WMO_90th_2D_updated0615, 'co.resi.baseline', 'in an institution', 'HW3')
getCoresi(HW4_WMO_90th_3D_updated0615, 'co.resi.baseline', 'in an institution', 'HW4')
getCoresi(HW5_WMO_95th_1D_updated0615, 'co.resi.baseline', 'in an institution', 'HW5')
getCoresi(HW6_WMO_95th_2D_updated0615, 'co.resi.baseline', 'in an institution', 'HW6')
getCoresi(HW7_WMO_95th_3D_updated0615, 'co.resi.baseline', 'in an institution', 'HW7')
getCoresi(HW8_NOAA_10degree_1D_updated0615, 'co.resi.baseline', 'in an institution', 'HW8')
getCoresi(HW9_NOAA_10degree_2D_updated0615, 'co.resi.baseline', 'in an institution', 'HW9')
getCoresi(HW10_NOAA_10degree_3D_updated0615, 'co.resi.baseline', 'in an institution', 'HW10')


getCSV(directory_path)

combineResults(directory_path,'/institution', 'institution.csv')
```







```{r social network}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\social network'
setwd(directory_path)

# social_network %>% select('id', 'f111.code', 'f112.code', 'f113.code') -> social.items
# HW1_CMA_updated0615 %>% left_join(social.items, by = 'id') ->HW1_CMA_updated0615
# HW2_WMO_90th_1D_updated0615 %>% left_join(social.items, by = 'id') -> HW2_WMO_90th_1D_updated0615
# HW3_WMO_90th_2D_updated0615 %>% left_join(social.items, by = 'id') -> HW3_WMO_90th_2D_updated0615
# HW4_WMO_90th_3D_updated0615 %>% left_join(social.items, by = 'id') -> HW4_WMO_90th_3D_updated0615
# HW5_WMO_95th_1D_updated0615 %>% left_join(social.items, by = 'id') -> HW5_WMO_95th_1D_updated0615
# HW6_WMO_95th_2D_updated0615 %>% left_join(social.items, by = 'id') -> HW6_WMO_95th_2D_updated0615
# HW7_WMO_95th_3D_updated0615 %>% left_join(social.items, by = 'id') -> HW7_WMO_95th_3D_updated0615
# HW8_NOAA_10degree_1D_updated0615 %>% left_join(social.items, by = 'id') -> HW8_NOAA_10degree_1D_updated0615
# HW9_NOAA_10degree_2D_updated0615 %>% left_join(social.items, by = 'id') -> HW9_NOAA_10degree_2D_updated0615
# HW10_NOAA_10degree_3D_updated0615 %>% left_join(social.items, by = 'id') -> HW10_NOAA_10degree_3D_updated0615



getSubGroup(HW1_CMA_updated0615, 'network.interact', 'HW1')
getSubGroup(HW2_WMO_90th_1D_updated0615, 'network.interact', 'HW2')
getSubGroup(HW3_WMO_90th_2D_updated0615, 'network.interact', 'HW3')
getSubGroup(HW4_WMO_90th_3D_updated0615, 'network.interact', 'HW4')
getSubGroup(HW5_WMO_95th_1D_updated0615, 'network.interact', 'HW5')
getSubGroup(HW6_WMO_95th_2D_updated0615, 'network.interact', 'HW6')
getSubGroup(HW7_WMO_95th_3D_updated0615, 'network.interact', 'HW7')
getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'network.interact', 'HW8')
getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'network.interact', 'HW9')
getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'network.interact', 'HW10')






# export csv
getCSV(directory_path)
combineResults(directory_path, '/strong', 'strong.csv')
combineResults(directory_path, '/weak','weak.csv')
combineResults(directory_path, '/nobody','nobody.csv')


```



```{r}
# test <- HW1_CMA_updated0615 %>%
#   mutate(personality_tertiles = factor(ntile(personality.score, 3), levels = 1:3, labels = c("Low", "Medium", "High")),
#          satisfaction_tertiles = factor(ntile(life.sat.score, 3), levels = 1:3, labels = c("Low", "Medium", "High")),
#          involvment_tertiles = factor(ntile(high.invol.act, 3), levels = 1:3, labels = c("Low", "Medium", "High"))
#          )
# head(test)

getTertiles = function(df){
  
  df.tertiles <- df %>%
  mutate(personality_tertiles = factor(ntile(personality.score, 3), levels = 1:3, labels = c("Low", "Medium", "High")),
         satisfaction_tertiles = factor(ntile(life.sat.score, 3), levels = 1:3, labels = c("Low", "Medium", "High")),
         involvment_tertiles = factor(ntile(high.invol.act, 3), levels = 1:3, labels = c("Low", "Medium", "High"))
         )
  
  
  return(df.tertiles)
}

getTertiles(HW1_CMA_updated0615) -> HW1_CMA_updated0615
getTertiles(HW2_WMO_90th_1D_updated0615) -> HW2_WMO_90th_1D_updated0615
getTertiles(HW3_WMO_90th_2D_updated0615) -> HW3_WMO_90th_2D_updated0615
getTertiles(HW4_WMO_90th_3D_updated0615) -> HW4_WMO_90th_3D_updated0615
getTertiles(HW5_WMO_95th_1D_updated0615) -> HW5_WMO_95th_1D_updated0615
getTertiles(HW6_WMO_95th_2D_updated0615) -> HW6_WMO_95th_2D_updated0615
getTertiles(HW7_WMO_95th_3D_updated0615) -> HW7_WMO_95th_3D_updated0615
getTertiles(HW8_NOAA_10degree_1D_updated0615) -> HW8_NOAA_10degree_1D_updated0615
getTertiles(HW9_NOAA_10degree_2D_updated0615) -> HW9_NOAA_10degree_2D_updated0615
getTertiles(HW10_NOAA_10degree_3D_updated0615) -> HW10_NOAA_10degree_3D_updated0615

colnames(HW1_CMA_updated0615)[colnames(HW1_CMA_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
colnames(HW2_WMO_90th_1D_updated0615)[colnames(HW2_WMO_90th_1D_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
colnames(HW3_WMO_90th_2D_updated0615)[colnames(HW3_WMO_90th_2D_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
colnames(HW4_WMO_90th_3D_updated0615)[colnames(HW4_WMO_90th_3D_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
colnames(HW5_WMO_95th_1D_updated0615)[colnames(HW5_WMO_95th_1D_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
colnames(HW6_WMO_95th_2D_updated0615)[colnames(HW6_WMO_95th_2D_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
colnames(HW7_WMO_95th_3D_updated0615)[colnames(HW7_WMO_95th_3D_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
colnames(HW8_NOAA_10degree_1D_updated0615)[colnames(HW8_NOAA_10degree_1D_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
colnames(HW9_NOAA_10degree_2D_updated0615)[colnames(HW9_NOAA_10degree_2D_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
colnames(HW10_NOAA_10degree_3D_updated0615)[colnames(HW10_NOAA_10degree_3D_updated0615) == "involvment_tertiles"] <- "involvement_tertiles"
```



```{r satisfaction}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\satisfaction'
setwd(directory_path)
getSubGroup(HW1_CMA_updated0615, 'satisfaction_tertiles', 'HW1')
getSubGroup(HW2_WMO_90th_1D_updated0615, 'satisfaction_tertiles', 'HW2')
getSubGroup(HW3_WMO_90th_2D_updated0615, 'satisfaction_tertiles', 'HW3')
getSubGroup(HW4_WMO_90th_3D_updated0615, 'satisfaction_tertiles', 'HW4')
getSubGroup(HW5_WMO_95th_1D_updated0615, 'satisfaction_tertiles', 'HW5')
getSubGroup(HW6_WMO_95th_2D_updated0615, 'satisfaction_tertiles', 'HW6')
getSubGroup(HW7_WMO_95th_3D_updated0615, 'satisfaction_tertiles', 'HW7')
getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'satisfaction_tertiles', 'HW8')
getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'satisfaction_tertiles', 'HW9')
getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'satisfaction_tertiles', 'HW10')


getCSV(directory_path)
combineResults(directory_path, '/high','high.csv')
combineResults(directory_path, '/medium','medium.csv')
combineResults(directory_path, '/low','low.csv')
```

```{r personality}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\personality'
setwd(directory_path)
getSubGroup(HW1_CMA_updated0615, 'personality_tertiles', 'HW1')
getSubGroup(HW2_WMO_90th_1D_updated0615, 'personality_tertiles', 'HW2')
getSubGroup(HW3_WMO_90th_2D_updated0615, 'personality_tertiles', 'HW3')
getSubGroup(HW4_WMO_90th_3D_updated0615, 'personality_tertiles', 'HW4')
getSubGroup(HW5_WMO_95th_1D_updated0615, 'personality_tertiles', 'HW5')
getSubGroup(HW6_WMO_95th_2D_updated0615, 'personality_tertiles', 'HW6')
getSubGroup(HW7_WMO_95th_3D_updated0615, 'personality_tertiles', 'HW7')
getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'personality_tertiles', 'HW8')
getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'personality_tertiles', 'HW9')
getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'personality_tertiles', 'HW10')


#getCSV(directory_path)
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\personality'
setwd(directory_path)
combineResults(directory_path, '/high','high.csv')
combineResults(directory_path, '/medium','medium.csv')
combineResults(directory_path, '/low','low.csv')
```


```{r high social involvenment}
directory_path <- 'D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\modelling\\result\\subgroup analysis\\social involvement'
setwd(directory_path)
# getSubGroup(HW1_CMA_updated0615, 'involvement_tertiles', 'HW1')
# getSubGroup(HW2_WMO_90th_1D_updated0615, 'involvement_tertiles', 'HW2')
# getSubGroup(HW3_WMO_90th_2D_updated0615, 'involvement_tertiles', 'HW3')
# getSubGroup(HW4_WMO_90th_3D_updated0615, 'involvement_tertiles', 'HW4')
# getSubGroup(HW5_WMO_95th_1D_updated0615, 'involvement_tertiles', 'HW5')
# getSubGroup(HW6_WMO_95th_2D_updated0615, 'involvement_tertiles', 'HW6')
# getSubGroup(HW7_WMO_95th_3D_updated0615, 'involvement_tertiles', 'HW7')
# getSubGroup(HW8_NOAA_10degree_1D_updated0615, 'involvement_tertiles', 'HW8')
# getSubGroup(HW9_NOAA_10degree_2D_updated0615, 'involvement_tertiles', 'HW9')
# getSubGroup(HW10_NOAA_10degree_3D_updated0615, 'involvement_tertiles', 'HW10')
# 
# 
# getCSV(directory_path)
combineResults(directory_path, '/high','high.csv')
combineResults(directory_path, '/medium','medium.csv')
combineResults(directory_path, '/low','low.csv')
```

