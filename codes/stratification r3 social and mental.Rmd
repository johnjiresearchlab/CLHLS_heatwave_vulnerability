---
title: "revision 3 add social factors"
author: "Di"
date: "2024-01-30"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(survival)
library(forestplot)
library(grid)
library(checkmate)
library(abind)
library(broom)
library(stringr)

directory_path = "E:\\DiXi\\heat vulnerability\\using threshold 5 years prior to exposure\\revision 3\\stratification"
```


```{r}
HW1_CMA_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW1_CMA_full.rds")

HW2_WMO_90TH_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW2_WMO_90TH_1D_full.rds")

HW3_WMO_90TH_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW3_WMO_90TH_2D_full.rds")

HW4_WMO_90TH_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW4_WMO_90TH_3D_full.rds")

HW5_WMO_95TH_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW5_WMO_95TH_1D_full.rds")

# HW6_WMO_95TH_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW6_WMO_95TH_2D_full.rds")
# 
# HW7_WMO_95TH_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW7_WMO_95TH_3D_full.rds")
# 
# HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")
# 
# HW9_NOAA_10C_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW9_NOAA_10C_2D_full.rds")
# 
# HW10_NOAA_10C_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW10_NOAA_10C_3D_full.rds")
```

```{R}
colnames(HW10_NOAA_10C_3D_full)
```




```{r function get subgroup}
getSubGroup.prov = function(df, stratify_var, def){

    
  stratify_levels <- as.character(na.omit(unique(df[[stratify_var]])))
  stratify_levels <- stratify_levels[!(stratify_levels %in% c("don't know"))]#; stratify_levels
  
 
  results = list()

    for (level in stratify_levels) {
      
    
      
      subset_data <- subset(df, df[[stratify_var]] == level)
    
      # Fit the Cox model
      
      # f <- paste0('Surv(tstart, times, event.death) ~ hwd.ind + pm25.scale + ndvi.scale + rh.scale + trueage + sex + strata(region) + cluster(id)')
      f <- paste0('Surv(tstart, times, event.death) ~ hwd.ind + trueage + sex + strata(prov) + cluster(id)')
      f = as.formula(f)
      coxfit <- coxph(f, data = subset_data)
    
      # Store the model results
      result <- coxfit %>% tidy(conf.int = TRUE, exponentiate = TRUE)
      
      results[[level]] <- result
    }
    
    saveRDS(results, paste0(def, '_', stratify_var, '.rds'))
    

    
    return(results)
}
```


############################ ################################ #######################################
############################ mental well-being ITEMS #######################################
############################ ################################ #######################################


```{r satisfaction_2}
#### female ####
setwd(paste0(directory_path, '\\satisfaction'))
# 
# getSubGroup.prov(HW1_CMA_full, 'satisfaction_2', 'HW1')
# getSubGroup.prov(HW2_WMO_90TH_1D_full, 'satisfaction_2', 'HW2')
# getSubGroup.prov(HW3_WMO_90TH_2D_full, 'satisfaction_2', 'HW3')
# getSubGroup.prov(HW4_WMO_90TH_3D_full, 'satisfaction_2', 'HW4')
# getSubGroup.prov(HW5_WMO_95TH_1D_full, 'satisfaction_2', 'HW5')
# getSubGroup.prov(HW6_WMO_95TH_2D_full, 'satisfaction_2', 'HW6')
# getSubGroup.prov(HW7_WMO_95TH_3D_full, 'satisfaction_2', 'HW7')
# getSubGroup.prov(HW8_NOAA_10C_1D_full, 'satisfaction_2', 'HW8')
# getSubGroup.prov(HW9_NOAA_10C_2D_full, 'satisfaction_2', 'HW9')
# getSubGroup.prov(HW10_NOAA_10C_3D_full, 'satisfaction_2', 'HW10')
# 
# getCSV(paste0(directory_path, '\\satisfaction'))
# combineResults(paste0(directory_path, '\\satisfaction'), '/low','low.csv')
# combineResults(paste0(directory_path, '\\satisfaction'), '/medium','medium.csv')
# combineResults(paste0(directory_path, '\\satisfaction'), '/high','high.csv')
# combineResults(paste0(directory_path, '\\satisfaction'), '/missing','missing.csv')

```


```{r personality_2}
#### female ####
setwd(paste0(directory_path, '\\personality'))

# getSubGroup.prov(HW1_CMA_full, 'personality_2', 'HW1')
# getSubGroup.prov(HW2_WMO_90TH_1D_full, 'personality_2', 'HW2')
# getSubGroup.prov(HW3_WMO_90TH_2D_full, 'personality_2', 'HW3')
# getSubGroup.prov(HW4_WMO_90TH_3D_full, 'personality_2', 'HW4')
# getSubGroup.prov(HW5_WMO_95TH_1D_full, 'personality_2', 'HW5')
# getSubGroup.prov(HW6_WMO_95TH_2D_full, 'personality_2', 'HW6')
# getSubGroup.prov(HW7_WMO_95TH_3D_full, 'personality_2', 'HW7')
# getSubGroup.prov(HW8_NOAA_10C_1D_full, 'personality_2', 'HW8')
# getSubGroup.prov(HW9_NOAA_10C_2D_full, 'personality_2', 'HW9')
# getSubGroup.prov(HW10_NOAA_10C_3D_full, 'personality_2', 'HW10')
# 
# getCSV(paste0(directory_path, '\\personality'))
# combineResults(paste0(directory_path, '\\personality'), '/low','low.csv')
# combineResults(paste0(directory_path, '\\personality'), '/medium','medium.csv')
# combineResults(paste0(directory_path, '\\personality'), '/high','high.csv')
# combineResults(paste0(directory_path, '\\personality'), '/missing','missing.csv')

```


############################ ################################ #######################################
############################ social ITEMS #######################################
############################ ################################ #######################################


```{r involvement_tertiles}
#### female ####
setwd(paste0(directory_path, '\\participation'))

# getSubGroup.prov(HW1_CMA_full, 'involvement_tertiles', 'HW1')
# getSubGroup.prov(HW2_WMO_90TH_1D_full, 'involvement_tertiles', 'HW2')
# getSubGroup.prov(HW3_WMO_90TH_2D_full, 'involvement_tertiles', 'HW3')
# getSubGroup.prov(HW4_WMO_90TH_3D_full, 'involvement_tertiles', 'HW4')
# getSubGroup.prov(HW5_WMO_95TH_1D_full, 'involvement_tertiles', 'HW5')
# getSubGroup.prov(HW6_WMO_95TH_2D_full, 'involvement_tertiles', 'HW6')
# getSubGroup.prov(HW7_WMO_95TH_3D_full, 'involvement_tertiles', 'HW7')
# getSubGroup.prov(HW8_NOAA_10C_1D_full, 'involvement_tertiles', 'HW8')
# getSubGroup.prov(HW9_NOAA_10C_2D_full, 'involvement_tertiles', 'HW9')
# getSubGroup.prov(HW10_NOAA_10C_3D_full, 'involvement_tertiles', 'HW10')
# 
# getCSV(paste0(directory_path, '\\participation'))
# combineResults(paste0(directory_path, '\\participation'), '/low','low.csv')
# combineResults(paste0(directory_path, '\\participation'), '/medium','medium.csv')
# combineResults(paste0(directory_path, '\\participation'), '/high','high.csv')


```



```{r network.interact}
#### female ####
setwd(paste0(directory_path, '\\network'))

# getSubGroup.prov(HW1_CMA_full, 'network.interact', 'HW1')
# getSubGroup.prov(HW2_WMO_90TH_1D_full, 'network.interact', 'HW2')
# getSubGroup.prov(HW3_WMO_90TH_2D_full, 'network.interact', 'HW3')
# getSubGroup.prov(HW4_WMO_90TH_3D_full, 'network.interact', 'HW4')
# getSubGroup.prov(HW5_WMO_95TH_1D_full, 'network.interact', 'HW5')
# getSubGroup.prov(HW6_WMO_95TH_2D_full, 'network.interact', 'HW6')
# getSubGroup.prov(HW7_WMO_95TH_3D_full, 'network.interact', 'HW7')
# getSubGroup.prov(HW8_NOAA_10C_1D_full, 'network.interact', 'HW8')
# getSubGroup.prov(HW9_NOAA_10C_2D_full, 'network.interact', 'HW9')
# getSubGroup.prov(HW10_NOAA_10C_3D_full, 'network.interact', 'HW10')
# 
# getCSV(paste0(directory_path, '\\network'))
# combineResults(paste0(directory_path, '\\network'), '/strong','strong.csv')
# combineResults(paste0(directory_path, '\\network'), '/weak','weak.csv')
# combineResults(paste0(directory_path, '\\network'), '/nobody','nobody.csv')


```



############################ ################################ #######################################
############################ social network interaction ITEMS #######################################
############################ ################################ #######################################

```{r}
social_network %>% select(id, f111.code, f112.code, f113.code) -> social.items


addItems = function(df){

  df %>% #left_join(adl_items, by = 'id') -> df
         left_join(social.items, by = 'id') -> df

  return(df)
}

# addItems(HW1_CMA_full) -> HW1_CMA_full
# addItems(HW2_WMO_90TH_1D_full) -> HW2_WMO_90TH_1D_full
# addItems(HW3_WMO_90TH_2D_full) -> HW3_WMO_90TH_2D_full
# addItems(HW4_WMO_90TH_3D_full) -> HW4_WMO_90TH_3D_full
# addItems(HW5_WMO_95TH_1D_full) -> HW5_WMO_95TH_1D_full
# addItems(HW6_WMO_95TH_2D_full) -> HW6_WMO_95TH_2D_full
# addItems(HW7_WMO_95TH_3D_full) -> HW7_WMO_95TH_3D_full
# addItems(HW8_NOAA_10C_1D_full) -> HW8_NOAA_10C_1D_full
# addItems(HW9_NOAA_10C_2D_full) -> HW9_NOAA_10C_2D_full
# addItems(HW10_NOAA_10C_3D_full) -> HW10_NOAA_10C_3D_full

```

```{r f111}
setwd(paste0(directory_path, '\\f111'))

getSubGroup.prov(HW1_CMA_full, 'f111.code', 'HW1')
getSubGroup.prov(HW2_WMO_90TH_1D_full, 'f111.code', 'HW2')
getSubGroup.prov(HW3_WMO_90TH_2D_full, 'f111.code', 'HW3')
getSubGroup.prov(HW4_WMO_90TH_3D_full, 'f111.code', 'HW4')
getSubGroup.prov(HW5_WMO_95TH_1D_full, 'f111.code', 'HW5')
getSubGroup.prov(HW6_WMO_95TH_2D_full, 'f111.code', 'HW6')
getSubGroup.prov(HW7_WMO_95TH_3D_full, 'f111.code', 'HW7')
getSubGroup.prov(HW8_NOAA_10C_1D_full, 'f111.code', 'HW8')
getSubGroup.prov(HW9_NOAA_10C_2D_full, 'f111.code', 'HW9')
getSubGroup.prov(HW10_NOAA_10C_3D_full, 'f111.code', 'HW10')


# getCSV(paste0(directory_path, '\\f111'))
# combineResults(paste0(directory_path, '\\f111'), '/strong','strong tie.csv')
# combineResults(paste0(directory_path, '\\f111'), '/weak','weak tie.csv')
# combineResults(paste0(directory_path, '\\f111'), '/nobody','nobody.csv')
```


```{r f112}
setwd(paste0(directory_path, '\\f112'))

getSubGroup.prov(HW1_CMA_full, 'f112.code', 'HW1')
getSubGroup.prov(HW2_WMO_90TH_1D_full, 'f112.code', 'HW2')
getSubGroup.prov(HW3_WMO_90TH_2D_full, 'f112.code', 'HW3')
getSubGroup.prov(HW4_WMO_90TH_3D_full, 'f112.code', 'HW4')
getSubGroup.prov(HW5_WMO_95TH_1D_full, 'f112.code', 'HW5')
getSubGroup.prov(HW6_WMO_95TH_2D_full, 'f112.code', 'HW6')
getSubGroup.prov(HW7_WMO_95TH_3D_full, 'f112.code', 'HW7')
getSubGroup.prov(HW8_NOAA_10C_1D_full, 'f112.code', 'HW8')
getSubGroup.prov(HW9_NOAA_10C_2D_full, 'f112.code', 'HW9')
getSubGroup.prov(HW10_NOAA_10C_3D_full, 'f112.code', 'HW10')


# getCSV(paste0(directory_path, '\\f112'))
# combineResults(paste0(directory_path, '\\f112'), '/strong','strong tie.csv')
# combineResults(paste0(directory_path, '\\f112'), '/weak','weak tie.csv')
# combineResults(paste0(directory_path, '\\f112'), '/nobody','nobody.csv')
```


```{r f113}
setwd(paste0(directory_path, '\\f113'))

getSubGroup.prov(HW1_CMA_full, 'f113.code', 'HW1')
getSubGroup.prov(HW2_WMO_90TH_1D_full, 'f113.code', 'HW2')
getSubGroup.prov(HW3_WMO_90TH_2D_full, 'f113.code', 'HW3')
getSubGroup.prov(HW4_WMO_90TH_3D_full, 'f113.code', 'HW4')
getSubGroup.prov(HW5_WMO_95TH_1D_full, 'f113.code', 'HW5')
getSubGroup.prov(HW6_WMO_95TH_2D_full, 'f113.code', 'HW6')
getSubGroup.prov(HW7_WMO_95TH_3D_full, 'f113.code', 'HW7')
getSubGroup.prov(HW8_NOAA_10C_1D_full, 'f113.code', 'HW8')
getSubGroup.prov(HW9_NOAA_10C_2D_full, 'f113.code', 'HW9')
getSubGroup.prov(HW10_NOAA_10C_3D_full, 'f111.code', 'HW10')


# getCSV(paste0(directory_path, '\\f113'))
# combineResults(paste0(directory_path, '\\f113'), '/strong','strong tie.csv')
# combineResults(paste0(directory_path, '\\f113'), '/weak','weak tie.csv')
# combineResults(paste0(directory_path, '\\f113'), '/nobody','nobody.csv')
```









