---
title: "progressive model_with survivors"
author: "Di"
date: "2023-10-21"
output: html_document
---



```{r setup, include=FALSE}
#knitr::opts_chunk$set(root.dir = "D:/DiXi/data preparation/environmental info/single events identification/heat and cold/cold - 5 year/")


knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(survival)
library(forestplot)
library(grid)
library(checkmate)
library(abind)
library(broom)
library(ggplot2)
library(stringr)
library(splines)
library(lubridate)

directory_path = "D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\revision 2\\strata prov\\main model"
```

```{r update dataset}
update_full = function(df){
  
  df$event.death <- ifelse(df$final_status == 'death' & month(df$dend) %in% c(1:4, 10:12), 0, df$event.death)
  
  df$iadl_3 = NA
  df$iadl_3[which(df$iadl.score == 8)] = 'Full function'
  df$iadl_3[which(df$iadl.score >= 9 & df$iadl.score <=16)] = 'Moderate impairment'
  df$iadl_3[which(df$iadl.score >= 17 & df$iadl.score <=24)] = 'Severe impairment'

  return(df)
  
}


# update_full(HW1_CMA_full) -> HW1_CMA_full
# update_full(HW2_WMO_90TH_1D_full) -> HW2_WMO_90TH_1D_full
# update_full(HW3_WMO_90TH_2D_full) -> HW3_WMO_90TH_2D_full
# update_full(HW4_WMO_90TH_3D_full) -> HW4_WMO_90TH_3D_full
# update_full(HW5_WMO_95TH_1D_full) -> HW5_WMO_95TH_1D_full
# update_full(HW6_WMO_95TH_2D_full) -> HW6_WMO_95TH_2D_full
# update_full(HW7_WMO_95TH_3D_full) -> HW7_WMO_95TH_3D_full
# update_full(HW8_NOAA_10C_1D_full) -> HW8_NOAA_10C_1D_full
# update_full(HW9_NOAA_10C_2D_full) -> HW9_NOAA_10C_2D_full
# update_full(HW10_NOAA_10C_3D_full) -> HW10_NOAA_10C_3D_full
gc()
#table(HW7_WMO_95TH_3D_full$event.death)

#table(HW10_NOAA_10C_3D_full$iadl_3)
```


########## model 7.1 single envi adjusted:#########
```{r envi adjusted model ndv}
getHWndvi = function(dataset, file_name){

    mod = coxph(Surv(tstart, times, event.death) ~
                  # exposure and environmental covariates
                  hwd.ind + ndvi.scale + #rh.scale +  pm25.scale +
                  # demographical factors
                  trueage + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
                  # physical logical disorder and cognitive disorder
                  adl.status + mmse.status.baseline + iadl_3 +
                  # smoking and drinking
                  d71 + d81 +
                
                  strata(prov) + cluster(id), data = dataset)


    mod %>% tidy(conf.int = TRUE, exponentiate = TRUE) -> result

    result %>% filter(term == 'hwd.ind') %>% select(term, estimate, conf.low, conf.high, p.value)  %>%
               summarise(term = term,
                         HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                         p = round(p.value,4)) -> result

    write.csv(result, paste0(file_name, '_model ndvi.csv'))

}


setwd(paste0(directory_path, '\\model envi\\ndvi'))

# getHWndvi(HW1_CMA_full, 'HW1')
# getHWndvi(HW2_WMO_90TH_1D_full, 'HW2')
# getHWndvi(HW3_WMO_90TH_2D_full, 'HW3')
# getHWndvi(HW4_WMO_90TH_3D_full, 'HW4')
# getHWndvi(HW5_WMO_95TH_1D_full, 'HW5')
# getHWndvi(HW6_WMO_95TH_2D_full, 'HW6')
# getHWndvi(HW7_WMO_95TH_3D_full, 'HW7')
# getHWndvi(HW8_NOAA_10C_1D_full, 'HW8')
# getHWndvi(HW9_NOAA_10C_2D_full, 'HW9')
# getHWndvi(HW10_NOAA_10C_3D_full, 'HW10')
# 
combineResults(paste0(directory_path, '\\model envi\\ndvi'), '', 'HW envi model ndvi.csv')

gc()
```


```{r envi adjusted model pm25}
getHWpm25 = function(dataset, file_name){

    mod = coxph(Surv(tstart, times, event.death) ~
                  # exposure and environmental covariates
                  hwd.ind + pm25.scale + #rh.scale +  ndvi.scale +
                  # demographical factors
                  trueage + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
                  # physical logical disorder and cognitive disorder
                  adl.status + mmse.status.baseline + iadl_3 +
                  # smoking and drinking
                  d71 + d81 +
                
                  strata(prov) + cluster(id), data = dataset)


    mod %>% tidy(conf.int = TRUE, exponentiate = TRUE) -> result

    result %>% filter(term == 'hwd.ind') %>% select(term, estimate, conf.low, conf.high, p.value)  %>%
               summarise(term = term,
                         HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                         p = round(p.value,4)) -> result

    write.csv(result, paste0(file_name, '_model pm25.csv'))

}


setwd(paste0(directory_path, '\\model envi\\pm25'))

# getHWpm25(HW1_CMA_full, 'HW1')
# getHWpm25(HW2_WMO_90TH_1D_full, 'HW2')
# getHWpm25(HW3_WMO_90TH_2D_full, 'HW3')
# getHWpm25(HW4_WMO_90TH_3D_full, 'HW4')
# getHWpm25(HW5_WMO_95TH_1D_full, 'HW5')
# getHWpm25(HW6_WMO_95TH_2D_full, 'HW6')
# getHWpm25(HW7_WMO_95TH_3D_full, 'HW7')
# getHWpm25(HW8_NOAA_10C_1D_full, 'HW8')
# getHWpm25(HW9_NOAA_10C_2D_full, 'HW9')
# getHWpm25(HW10_NOAA_10C_3D_full, 'HW10')
# 
 combineResults(paste0(directory_path, '\\model envi\\pm25'), '', 'HW envi model pm25.csv')

gc()
```


```{r envi adjusted model linear rh}
getHWrh.linear = function(dataset, file_name){

    mod = coxph(Surv(tstart, times, event.death) ~
                  # exposure and environmental covariates
                  hwd.ind + rh.scale +  #ndvi.scale +
                  # demographical factors
                  trueage + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
                  # physical logical disorder and cognitive disorder
                  adl.status + mmse.status.baseline + iadl_3 +
                  # smoking and drinking
                  d71 + d81 +
                
                  strata(prov) + cluster(id), data = dataset)


    mod %>% tidy(conf.int = TRUE, exponentiate = TRUE) -> result

    result %>% filter(term == 'hwd.ind') %>% select(term, estimate, conf.low, conf.high, p.value)  %>%
               summarise(term = term,
                         HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                         p = round(p.value,4)) -> result

    write.csv(result, paste0(file_name, '_model linear rh.csv'))

}


setwd(paste0(directory_path, '\\model envi\\rh'))

# getHWrh.linear(HW1_CMA_full, 'HW1')
# getHWrh.linear(HW2_WMO_90TH_1D_full, 'HW2')
# getHWrh.linear(HW3_WMO_90TH_2D_full, 'HW3')
# getHWrh.linear(HW4_WMO_90TH_3D_full, 'HW4')
# getHWrh.linear(HW5_WMO_95TH_1D_full, 'HW5')
# getHWrh.linear(HW6_WMO_95TH_2D_full, 'HW6')
# getHWrh.linear(HW7_WMO_95TH_3D_full, 'HW7')
# getHWpm25(HW8_NOAA_10C_1D_full, 'HW8')
# getHWpm25(HW9_NOAA_10C_2D_full, 'HW9')
# getHWpm25(HW10_NOAA_10C_3D_full, 'HW10')
# 
 combineResults(paste0(directory_path, '\\model envi\\rh'), '', 'HW envi model linear rh.csv')

gc()
```



############# Model 7 fully adjusted #########
```{r fully adjusted model with out rh}
getFullyAdjustedHW2 = function(dataset, file_name){

    mod = coxph(Surv(tstart, times, event.death) ~
                  # exposure and environmental covariates
                  hwd.ind + pm25.scale + ndvi.scale + 
                  # demographical factors
                  trueage + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
                  # physical logical disorder and cognitive disorder
                  adl.status + mmse.status.baseline + iadl_3 +
                  # smoking and drinking
                  d71 + d81 +
                
                  strata(prov) + cluster(id), data = dataset)

    mod %>% tidy(conf.int = TRUE, exponentiate = TRUE) -> result

    result %>% filter(term == 'hwd.ind') %>% select(term, estimate, conf.low, conf.high, p.value)  %>%
               summarise(term = term,
                         HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                         p = round(p.value,4)) -> result

    write.csv(result, paste0(file_name, '_model fully adjusted without rh.csv'))

}


setwd(paste0(directory_path, '\\model envi\\fully adjusted without rh'))

# getFullyAdjustedHW2(HW1_CMA_full, 'HW1')
# getFullyAdjustedHW2(HW2_WMO_90TH_1D_full, 'HW2')
# getFullyAdjustedHW2(HW3_WMO_90TH_2D_full, 'HW3')
# getFullyAdjustedHW2(HW4_WMO_90TH_3D_full, 'HW4')
# getFullyAdjustedHW2(HW5_WMO_95TH_1D_full, 'HW5')
# getFullyAdjustedHW2(HW6_WMO_95TH_2D_full, 'HW6')
# getFullyAdjustedHW2(HW7_WMO_95TH_3D_full, 'HW7')
# getFullyAdjustedHW2(HW8_NOAA_10C_1D_full, 'HW8')
# getFullyAdjustedHW2(HW9_NOAA_10C_2D_full, 'HW9')
# getFullyAdjustedHW2(HW10_NOAA_10C_3D_full, 'HW10')
gc()

 combineResults(paste0(directory_path, '\\model envi\\fully adjusted without rh'), '', 'HW model fully adjusted without rh.csv')


```


############# Model 8 fully adjusted NON-LINEAR TERM #########
```{r fully adjusted model}
getHW.model8 = function(dataset, file_name){

    mod = coxph(Surv(tstart, times, event.death) ~
                                # exposure and environmental covariates
                                hwd.ind + pm25.scale + ndvi.scale + ns(rh.scale) +
                                # demographical factors
                                trueage + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
                                # physical logical disorder and cognitive disorder
                                adl.status + mmse.status.baseline + iadl_3 +
                                # smoking and drinking
                                d71 + d81 +
                
                  strata(prov) + cluster(id), data = dataset)

    mod %>% tidy(conf.int = TRUE, exponentiate = TRUE) -> result

    result %>% filter(term == 'hwd.ind') %>% select(term, estimate, conf.low, conf.high, p.value)  %>%
               summarise(term = term,
                         HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                         p = round(p.value,4)) -> result

    write.csv(result, paste0(file_name, '_model 8.csv'))

}


setwd(paste0(directory_path, '\\model 8'))

# getHW.model8(HW1_CMA_full, 'HW1')
# getHW.model8(HW2_WMO_90TH_1D_full, 'HW2')
# getHW.model8(HW3_WMO_90TH_2D_full, 'HW3')
# getHW.model8(HW4_WMO_90TH_3D_full, 'HW4')
# getHW.model8(HW5_WMO_95TH_1D_full, 'HW5')
# getHW.model8(HW6_WMO_95TH_2D_full, 'HW6')
# getHW.model8(HW7_WMO_95TH_3D_full, 'HW7')
# getHW.model8(HW8_NOAA_10C_1D_full, 'HW8')
# getHW.model8(HW9_NOAA_10C_2D_full, 'HW9')
# getHW.model8(HW10_NOAA_10C_3D_full, 'HW10')

 combineResults(paste0(directory_path, '\\model 8'), '', 'HW full model 8 with non-linear term.csv')


```


####################################################################
###################### model 9: all rh adjusted##################

```{r}
getAllRHadjusted = function(dataset, file_name){

    mod = coxph(Surv(tstart, times, event.death) ~
                  # exposure and environmental covariates
                  hwd.ind + pm25.scale + ndvi.scale + rh.scale +
                  # demographical factors
                  trueage + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
                  # physical logical disorder and cognitive disorder
                  adl.status + mmse.status.baseline + iadl_3 +
                  # smoking and drinking
                  d71 + d81 +
                
                  strata(prov) + cluster(id), data = dataset)


    mod %>% tidy(conf.int = TRUE, exponentiate = TRUE) -> result

    result %>% filter(term == 'hwd.ind') %>% select(term, estimate, conf.low, conf.high, p.value)  %>%
               summarise(term = term,
                         HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                         p = round(p.value,4)) -> result

    write.csv(result, paste0(file_name, '_model 9.csv'))

}


setwd(paste0(directory_path, '\\model 9'))

# getAllRHadjusted(HW1_CMA_full, 'HW1')
# getAllRHadjusted(HW2_WMO_90TH_1D_full, 'HW2')
# getAllRHadjusted(HW3_WMO_90TH_2D_full, 'HW3')
# getAllRHadjusted(HW4_WMO_90TH_3D_full, 'HW4')
# getAllRHadjusted(HW5_WMO_95TH_1D_full, 'HW5')
# getAllRHadjusted(HW6_WMO_95TH_2D_full, 'HW6')
# getAllRHadjusted(HW7_WMO_95TH_3D_full, 'HW7')
# 
# getAllRHadjusted(HW8_NOAA_10C_1D_full, 'HW8')
# getAllRHadjusted(HW9_NOAA_10C_2D_full, 'HW9')
# getAllRHadjusted(HW10_NOAA_10C_3D_full, 'HW10')

gc()

combineResults(paste0(directory_path, '\\model 9'), '', 'HW full model 9 - all rh adjusted.csv')

```



===========================================================================================
===========================================================================================
===========================================================================================






