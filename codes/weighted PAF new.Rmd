---
title: "PAF"
author: "Di"
date: "2023-08-08"
output: html_document
---

```{r setup, include=FALSE}
#library(epiR)
install.packages("polycor")
library(graphPAF)
#library(paf)
library(boot)
library(psych)
library(polycor)
library(dplyr)

```


```{r}
HW1_CMA_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW1_CMA_full.rds")
# 
HW2_WMO_90TH_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW2_WMO_90TH_1D_full.rds")
# 
# HW3_WMO_90TH_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW3_WMO_90TH_2D_full.rds")
# 
# HW4_WMO_90TH_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW4_WMO_90TH_3D_full.rds")
# 
# HW5_WMO_95TH_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW5_WMO_95TH_1D_full.rds")

# HW6_WMO_95TH_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW6_WMO_95TH_2D_full.rds")
# 
# HW7_WMO_95TH_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW7_WMO_95TH_3D_full.rds")
# 
# HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")
# 
# HW9_NOAA_10C_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW9_NOAA_10C_2D_full.rds")
# 
# HW10_NOAA_10C_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW10_NOAA_10C_3D_full.rds")
```

```{r}
# Example data
# df = HW8_NOAA_10degree_1D_updated0615
# hr <- HW10_fully_adjusted$estimate[1]; hr
# 
# head(df)

getWeightedPAF = function(df, hr){
    data_matrix <- df %>% select(hwd.ind, trueage, sex, #UorR, co.resi.baseline, marital.baseline, 
                                 ndvi.scale, pm25.scale, rh.scale, # education, occupation
                                 adl.status, iadl.status, mmse.status.baseline)%>%mutate_all(~ as.numeric(factor(.)))
                                 #life.sat.score, personality.score, 
                                 #fruit, veg, tea, d71, d81, d91,
                                 #high.invol.act,f113.code) %>%
    
    pca_cor<-hetcor(data_matrix,ML=TRUE)
     
    # step3. conduct a PCA on the correlation matrix to generate eigenvectors
    my_pca <- princomp(pca_cor, n.comp = sum(my_pca$sdev^2 >= 1))
     
    # screen plot to find the elbow
    eig_df <- data.frame(Comp = 1:length(my_pca$sdev), Eigenvalue = my_pca$sdev^2)
    # Plot the scree plot
    # ggplot(eig_df, aes(x = Comp, y = Eigenvalue)) +
    #   geom_point(size = 3, color = "red") +
    #   geom_line(size = 1.2, color = "blue") +
    #   xlab("Component") +
    #   ylab("Eigenvalue") +
    #   ggtitle("Scree Plot")
     
    # the 'elbow' in this example is 2
     
    # step4. retain components with eighvalues â‰¥1 in the model. Then communality can be calculated as the sum of the square of all factor loadings
    my_loadings<-my_pca$loadings
    my_communality<-rowSums(my_loadings[,1:2]^2)



    # number of events occurred among the group exposed/unexposed to heatwave
    df %>% filter(event.death == 1 & hwd.ind == 1) %>% summarise(event.exposed = n()) -> event.exposed; event.exposed = as.numeric(event.exposed)
    df %>% filter(event.death == 1 & hwd.ind == 0) %>% summarise(event.unexposed = n()) -> event.unexposed; event.unexposed = as.numeric(event.unexposed)
    
    #  the amount of person time while being exposed/unexposed to a particular risk 
    df %>% filter(hwd.ind == 1) %>% summarise(pt.exposed = n()) -> pt.exposed; pt.exposed = as.numeric(pt.exposed)
    df %>% filter(hwd.ind == 0) %>% summarise(pt.unexposed = n()) -> pt.unexposed; pt.unexposed = as.numeric(pt.unexposed)
    
    
    # Calculate incidence rates
    ir_exposed <- event.exposed / pt.exposed
    ir_unexposed <- event.unexposed / pt.unexposed
    
    # Calculate Attributable Fraction
    af <- (ir_exposed - ir_unexposed) / ir_exposed
    
    # Calculate Population Attributable Fraction
    paf <- (af * hr) / (1 + af * (hr - 1))
    
    
    adjusted_af <- af * my_communality[1]  # Adjust for communality
    adjusted_paf <- (adjusted_af * hr) / (1 + adjusted_af * (hr - 1))
    # Print the calculated PAF
    cat("Population Attributable Fraction (PAF) using HR:", adjusted_paf, "\n")
    
    
    # Define a function to calculate PAF
    calculate_paf <- function(data, indices, hr) {
    
        event.exposed <- sum(data$event.death[indices] == 1 & data$hwd.ind[indices] == 1)
        event.unexposed <- sum(data$event.death[indices] == 1 & data$hwd.ind[indices] == 0)
        pt.exposed <- sum(data$hwd.ind[indices] == 1)
        pt.unexposed <- sum(data$hwd.ind[indices] == 0)
        
        ir_exposed <- event.exposed / pt.exposed
        ir_unexposed <- event.unexposed / pt.unexposed
        af <- (ir_exposed - ir_unexposed) / ir_exposed
        adjusted_af <- af * my_communality[1]  # Adjust for communality
        adjusted_paf <- (adjusted_af * hr) / (1 + adjusted_af * (hr - 1))
        
        
    return(adjusted_paf)
    }




    # Set the number of bootstrap replicates
    n_replicates <- 1000
    
    # Perform bootstrap and calculate CI for PAF
    boot_results <- boot(data = df, statistic = calculate_paf, R = n_replicates, hr = hr)
    
    # Calculate the confidence interval using basic method
    ci <- boot.ci(boot_results, type = "basic", conf = 0.95)
    
    
  
    
    print(ci); print(paste0('p-value', mean(abs(boot_results$t) > abs(boot_results$t0))))
    
    return(boot_results)
    
}


getPValueFromBootstrap <- function(boot_results, observed_statistic) {
  # Calculate the number of replicates
  n_replicates <- length(boot_results$t)
  
  # Calculate the proportion of replicates greater or less than the observed statistic
  p_value <- sum(abs(boot_results$t - observed_statistic) >= abs(boot_results$t0 - observed_statistic)) / n_replicates
  
  return(p_value)
}

# getPValueFromBootstrap(test2, test2$t0)

# hr <- c(1.41,2.07,2.06,1.95,2,2.46,2.31)
# 
# getWeightedPAF(HW10_NOAA_10C_3D_death, hr[7]) 
# # getWeightedPAF(HW9_NOAA_10degree_2D_updated0615, HW9_fully_adjusted$estimate[1])
# getWeightedPAF(HW8_NOAA_10C_1D_death, hr[6])
# getWeightedPAF(HW7_WMO_95TH_3D_death, hr[5])
# # getWeightedPAF(HW6_WMO_95th_2D_updated0615, HW6_fully_adjusted$estimate[1])
# getWeightedPAF(HW5_WMO_95TH_1D_death, hr[4])
# getWeightedPAF(HW4_WMO_90TH_3D_death, hr[3])
# # getWeightedPAF(HW3_WMO_90th_2D_updated0615, HW3_fully_adjusted$estimate[1])
# getWeightedPAF(HW2_WMO_90TH_1D_death, hr[2])
# getWeightedPAF(HW1_CMA_death, hr[1])

```

###### paf prov ########
```{r hr strata prov}
# hr <- c(1.26, 1.93, 1.95, 1.87, 1.8, 1.82, 1.85, 1.97, 1.93, 1.78)
 hr <- c(1.25, 1.93, 1.95, 1.86, 1.8, 1.82, 1.85, 1.98, 1.94, 1.78)
```


```{r}
# getWeightedPAF(HW1_CMA_death, hr[1])
# getWeightedPAF(HW2_WMO_90TH_1D_death, hr[2])
# getWeightedPAF(HW3_WMO_90TH_2D_full, hr[3])
# getWeightedPAF(HW4_WMO_90TH_3D_full, hr[4])
# gc()
# getWeightedPAF(HW5_WMO_95TH_1D_full, hr[5])
# gc()
getWeightedPAF(HW6_WMO_95TH_2D_full, hr[6])
gc()

# getWeightedPAF(HW8_NOAA_10C_1D_full, hr[8])
# getWeightedPAF(HW9_NOAA_10C_2D_full, hr[9])
# getWeightedPAF(HW10_NOAA_10C_3D_death, hr[10])

```



```{r}
# getWeightedPAF(HW1_CMA_death, hr[1])
# getWeightedPAF(HW2_WMO_90TH_1D_death, hr[2])
# getWeightedPAF(HW3_WMO_90TH_2D_full, hr[3])
# getWeightedPAF(HW4_WMO_90TH_3D_full, hr[4])
# gc()
# getWeightedPAF(HW5_WMO_95TH_1D_full, hr[5])
# gc()

getWeightedPAF(HW7_WMO_95TH_3D_full, hr[7])
gc()
# getWeightedPAF(HW8_NOAA_10C_1D_full, hr[8])
# getWeightedPAF(HW9_NOAA_10C_2D_full, hr[9])
# getWeightedPAF(HW10_NOAA_10C_3D_death, hr[10])

```


```{r}
# getWeightedPAF(HW1_CMA_death, hr[1])
# getWeightedPAF(HW2_WMO_90TH_1D_death, hr[2])
# getWeightedPAF(HW3_WMO_90TH_2D_full, hr[3])
# getWeightedPAF(HW4_WMO_90TH_3D_full, hr[4])
# gc()
# getWeightedPAF(HW5_WMO_95TH_1D_full, hr[5])
# gc()

# getWeightedPAF(HW7_WMO_95TH_3D_full, hr[7])
# gc()

# HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")
getWeightedPAF(HW8_NOAA_10C_1D_full, hr[8])
gc()
# getWeightedPAF(HW9_NOAA_10C_2D_full, hr[9])
# getWeightedPAF(HW10_NOAA_10C_3D_death, hr[10])

```



```{r}
# getWeightedPAF(HW1_CMA_death, hr[1])
# getWeightedPAF(HW2_WMO_90TH_1D_death, hr[2])
# getWeightedPAF(HW3_WMO_90TH_2D_full, hr[3])
# getWeightedPAF(HW4_WMO_90TH_3D_full, hr[4])
# gc()
# getWeightedPAF(HW5_WMO_95TH_1D_full, hr[5])
# gc()

# getWeightedPAF(HW7_WMO_95TH_3D_full, hr[7])
# gc()

# HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")


HW9_NOAA_10C_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW9_NOAA_10C_2D_full.rds")
getWeightedPAF(HW9_NOAA_10C_2D_full, hr[9])
gc()
# getWeightedPAF(HW10_NOAA_10C_3D_death, hr[10])

```








```{r}
# getWeightedPAF(HW1_CMA_death, hr[1])
# getWeightedPAF(HW2_WMO_90TH_1D_death, hr[2])
# getWeightedPAF(HW3_WMO_90TH_2D_full, hr[3])
# getWeightedPAF(HW4_WMO_90TH_3D_full, hr[4])
# gc()
# getWeightedPAF(HW5_WMO_95TH_1D_full, hr[5])
# gc()

# getWeightedPAF(HW7_WMO_95TH_3D_full, hr[7])
# gc()

# HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")


# HW9_NOAA_10C_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW9_NOAA_10C_2D_full.rds")
# getWeightedPAF(HW9_NOAA_10C_2D_full, hr[9])

# HW10_NOAA_10C_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW10_NOAA_10C_3D_full.rds")

getWeightedPAF(HW10_NOAA_10C_3D_full, hr[10])
gc()

```






```{r}
getWeightedPAF(HW1_CMA_full, hr[1])
gc()
# getWeightedPAF(HW2_WMO_90TH_1D_death, hr[2])
# getWeightedPAF(HW3_WMO_90TH_2D_full, hr[3])
# getWeightedPAF(HW4_WMO_90TH_3D_full, hr[4])
# gc()
# getWeightedPAF(HW5_WMO_95TH_1D_full, hr[5])
# gc()

# getWeightedPAF(HW7_WMO_95TH_3D_full, hr[7])
# gc()

# HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")


# HW9_NOAA_10C_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW9_NOAA_10C_2D_full.rds")
# getWeightedPAF(HW9_NOAA_10C_2D_full, hr[9])

# HW10_NOAA_10C_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW10_NOAA_10C_3D_full.rds")

# getWeightedPAF(HW10_NOAA_10C_3D_full, hr[10])
# gc()

```


```{r}
# getWeightedPAF(HW1_CMA_death, hr[1])
# gc()
getWeightedPAF(HW2_WMO_90TH_1D_full, hr[2])
gc()
# getWeightedPAF(HW3_WMO_90TH_2D_full, hr[3])
# getWeightedPAF(HW4_WMO_90TH_3D_full, hr[4])
# gc()
# getWeightedPAF(HW5_WMO_95TH_1D_full, hr[5])
# gc()

# getWeightedPAF(HW7_WMO_95TH_3D_full, hr[7])
# gc()

# HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")


# HW9_NOAA_10C_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW9_NOAA_10C_2D_full.rds")
# getWeightedPAF(HW9_NOAA_10C_2D_full, hr[9])

# HW10_NOAA_10C_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW10_NOAA_10C_3D_full.rds")

# getWeightedPAF(HW10_NOAA_10C_3D_full, hr[10])
# gc()

```


```{r}
# getWeightedPAF(HW1_CMA_death, hr[1])
# gc()
# getWeightedPAF(HW2_WMO_90TH_1D_full, hr[2])
# gc()

HW3_WMO_90TH_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW3_WMO_90TH_2D_full.rds")
# 
# HW4_WMO_90TH_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW4_WMO_90TH_3D_full.rds")
# 
getWeightedPAF(HW3_WMO_90TH_2D_full, hr[3])
gc()

# getWeightedPAF(HW4_WMO_90TH_3D_full, hr[4])

# getWeightedPAF(HW5_WMO_95TH_1D_full, hr[5])
# gc()

# getWeightedPAF(HW7_WMO_95TH_3D_full, hr[7])
# gc()

# HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")


# HW9_NOAA_10C_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW9_NOAA_10C_2D_full.rds")
# getWeightedPAF(HW9_NOAA_10C_2D_full, hr[9])

# HW10_NOAA_10C_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW10_NOAA_10C_3D_full.rds")

# getWeightedPAF(HW10_NOAA_10C_3D_full, hr[10])
# gc()

```



```{r}
# getWeightedPAF(HW1_CMA_death, hr[1])
# gc()
# getWeightedPAF(HW2_WMO_90TH_1D_full, hr[2])
# gc()

# HW3_WMO_90TH_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW3_WMO_90TH_2D_full.rds")
# 
rm(HW3_WMO_90TH_2D_full)
HW4_WMO_90TH_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW4_WMO_90TH_3D_full.rds")
# 
# getWeightedPAF(HW3_WMO_90TH_2D_full, hr[3])


getWeightedPAF(HW4_WMO_90TH_3D_full, hr[4])
gc()
# getWeightedPAF(HW5_WMO_95TH_1D_full, hr[5])
# gc()

# getWeightedPAF(HW7_WMO_95TH_3D_full, hr[7])
# gc()

# HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")


# HW9_NOAA_10C_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW9_NOAA_10C_2D_full.rds")
# getWeightedPAF(HW9_NOAA_10C_2D_full, hr[9])

# HW10_NOAA_10C_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW10_NOAA_10C_3D_full.rds")

# getWeightedPAF(HW10_NOAA_10C_3D_full, hr[10])
# gc()

```





