---
title: "population_characteristics"
author: "Di"
date: "2023-10-20"
output: html_document
---



```{r}
library(table1)
library(dplyr)
library(lubridate)
```


#######################################################################
############################ death only ############################
#######################################################################


```{r}
basic_demo$id = as.factor(basic_demo$id)
mmse_baseline$id = as.factor(mmse_baseline$id)
# heatwave
survival_info_by_id %>% #subset(month(dend) %in% c(5,6,7,8,9)) %>% 
  left_join(basic_demo, by = c('id')) %>% 
  # left_join(pm25_D1K_08_18_id, by = c('id','date')) %>%
  # left_join(ndvi.orig, by = c('id','date')) %>%
  # individual characteristics
  left_join(mmse_baseline, by = c('id')) %>%
  left_join(adl, by = c('id')) %>%
  left_join(iadl_baseline, by = c('id')) %>% 
  left_join(section_b, by = c('id')) %>% 
  left_join(sec_d, by = c('id')) %>%
  left_join(marital_change, by = 'id') %>%
  left_join(edu_occu, by = 'id') %>%
  left_join(social_network[, c(1,11,12)], by = 'id') -> death.only.pop
  #left_join(sec_f, by = c('id')) -> dataset
  #left_join(rh_orig, by = c('id','date')) 

head(death.only.pop)
```

```{r generate dataset for table 1}
head(death.only.pop)


death.only.pop %>% mutate(dend = as.Date(dend),
                          
                          personality_tertiles = factor(ntile(personality.score, 3), levels = 1:3, labels = c("Low", "Medium", "High")),
                          satisfaction_tertiles = factor(ntile(life.sat.score, 3), levels = 1:3, labels = c("Low", "Medium", "High")),
                          involvement_tertiles = factor(ntile(high.invol.act, 3), levels = 1:3, labels = c("Low", "Medium", "High")),
                          
                          
                          inclexcl = case_when(final_status == 'death'& month(dend) %in% c(1:4,10:12)~ 'step 0: exclude non summer death',
                                               
                                               trueage < 65 ~ 'step 1：age<65',
 
                                              is.na(trueage)|is.na(co.resi.baseline)|is.na(education)|is.na(occupation)|
                                              is.na(marital.baseline)|is.na(fruit)|is.na(veg)|is.na(tea)|
                                              is.na(d71)|is.na(d91)|is.na(involvement_tertiles)|
                                              is.na(network.interact)|d91 == 'don\'t know' ~ 'step 2: few missing',
                                              
                                              final_status =='survival' ~ 'step 3: exclude survival',

                                              #final_status != 'death'|is.na(dend)|is.na(times) ~ 'total loss',
                                              
                                              final_status == 'loss in 2011/2012 survey'|is.na(dend)|is.na(times)   ~ 'step 4: exclude loss-to-follow-up at 1st survey (11/12)',
                                              
                                              final_status %in% c('loss in 2018 survey','loss in 2014 survey')  ~ 'step 5: exclude loss-to-follow-up at 14 or 18',
                                            
                                              final_status == 'death'& month(dend) %in% c(5,6,7,8,9) ~ 'step 6: inclusion summer death'
                                               
                                               ),
                          
                          UorR = case_when(residenc.baseline %in% c('city', 'town') ~ 'urban',
                                           residenc.baseline %in% c('rural') ~ 'rural'),
                          
                          
                          
                          iadl_2 = ifelse(is.na(iadl.status),"missing",iadl.status),
                          satisfaction_2 = ifelse(is.na(satisfaction_tertiles),"missing",satisfaction_tertiles),
                          personality_2 = ifelse(is.na(personality_tertiles),"missing",personality_tertiles),
                          
                          satisfaction_2 = case_when(satisfaction_2 == 1 ~ "Low",satisfaction_2 == 2 ~ "Medium",satisfaction_2 == 3 ~ "High",
                                                     TRUE ~ 'missing'),
                          personality_2 = case_when(personality_2 == 1 ~ "Low",personality_2 == 2 ~ "Medium",personality_2 == 3 ~ "High",
                                                     TRUE ~ 'missing')
                          
                          ) -> death.only.pop


```

```{r selection procedure }
death.only.pop$agegroup = NA
death.only.pop$agegroup[which(death.only.pop$trueage < 80)] = 'young_old'
death.only.pop$agegroup[which(death.only.pop$trueage >= 80 & death.only.pop$trueage <90)] = 'octogenarians'
death.only.pop$agegroup[which(death.only.pop$trueage >= 90 & death.only.pop$trueage <100)] = 'nonagenarians'
death.only.pop$agegroup[which(death.only.pop$trueage >= 100)] = 'centenarians'

table1(~# demographical factors            
         trueage + agegroup + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
           # physical logical disorder and cognitive disorder
            adl.status + mmse.status.baseline + iadl_2 +
            # mental health and personality
           satisfaction_2 + personality_2+
           # life style
           fruit + veg + tea + d71 + d81 + d91 +
            # social participation and network #low.invol.act +
            involvement_tertiles + network.interact|inclexcl, death.only.pop)

```


```{r}
table1(~# demographical factors            
          agegroup + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
           # physical logical disorder and cognitive disorder
            adl.status + mmse.status.baseline + iadl_2 +
            # mental health and personality
           satisfaction_2 + personality_2+
           # life style
           fruit + veg + tea + d71 + d81 + d91 +
            # social participation and network #low.invol.act +
            involvement_tertiles + network.interact|inclexcl, subset(death.only.pop,death.only.pop$inclexcl!="step 4: few missing"))

```











#######################################################################
############################ full sample size : find missing############################
#######################################################################



```{R}
inclexcl_criteria %>% mutate(dend = as.Date(dend),
                        
                          
                          
                          inclexcl = case_when(trueage < 65 ~ 'step 0：age<65',
                                               
                                                is.na(trueage)|is.na(co.resi.baseline)|is.na(education)|is.na(occupation)|
                                                is.na(marital.baseline)|is.na(iadl.status)|
                                                is.na(d71)|is.na(d81) == 'don\'t know' ~ 'step 1: few missing',
                                               
                                               #final_status != 'death'|is.na(dend)|is.na(times) ~ 'total loss',
                                              
                                              final_status == 'loss in 2011/2012 survey'|is.na(dend)|is.na(times)   ~ 'step 2: exclude loss-to-follow-up at 1st survey (11/12)',
                                              
                                              final_status %in% c('loss in 2018 survey','loss in 2014 survey')  ~ 'step 3: exclude loss-to-follow-up at 14 or 18',
                            
                                              final_status == 'death'& month(dend) %in% c(1:4,10:12)~ 'step 4: exclude non summer death',

                                              final_status == 'death'& month(dend) %in% c(5,6,7,8,9) ~ 'step 5: summer death',
                                              
                                               final_status =='survival' ~ 'step 6: exclude survival'
                                               
                                               ),
                          
                          UorR = case_when(residenc.baseline %in% c('city', 'town') ~ 'urban',
                                           residenc.baseline %in% c('rural') ~ 'rural'),
                          
                          
                          
                          iadl_2 = ifelse(is.na(iadl.status),"missing",iadl.status),
                          satisfaction_2 = ifelse(is.na(satisfaction_tertiles),"missing",satisfaction_tertiles),
                          personality_2 = ifelse(is.na(personality_tertiles),"missing",personality_tertiles),
                          
                          satisfaction_2 = case_when(satisfaction_2 == 1 ~ "Low",satisfaction_2 == 2 ~ "Medium",satisfaction_2 == 3 ~ "High",
                                                     TRUE ~ 'missing'),
                          personality_2 = case_when(personality_2 == 1 ~ "Low",personality_2 == 2 ~ "Medium",personality_2 == 3 ~ "High",
                                                     TRUE ~ 'missing')
                          
                          ) -> inclexcl_criteria_2

colnames(inclexcl_criteria_2)

setwd('D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\revision 2')
saveRDS(inclexcl_criteria_2, 'inclexcl_criteria_2.rds')
```

```{r selection procedure }
library(table1)

r2.inclu = inclexcl_criteria_2 %>% filter(!inclexcl %in% c('step 0：age<65',
                                                         'step 1: few missing',
                                                         'step 2: exclude loss-to-follow-up at 1st survey (11/12)'))
r2.inclu.id = r2.inclu %>% select(id)

adl.na.id = as.factor(inclexcl_criteria_2$id[which(is.na(inclexcl_criteria_2$adl.status))])
  
r2.inclu %>% filter(! id %in% adl.na.id) -> r2.inclu

table1(~# demographical factors            
         trueage + agegroup + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
           # physical logical disorder and cognitive disorder
            adl.status + mmse.status.baseline + iadl_3 +
          
           d71 + d81|sex, r2.inclu) -> sex.specific.table

library(writexl)

## write sex specific table
# write_xlsx(as.data.frame(sex.specific.table), path = "D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\revision 2\\population_characteristics_by_sex.xlsx")


table1(~# demographical factors            
         trueage + agegroup + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
           # physical logical disorder and cognitive disorder
            adl.status + mmse.status.baseline + iadl_3 +
          
           d71 + d81|inclexcl, r2.inclu) -> final.ppl

## write population component table
write_xlsx(as.data.frame(final.ppl), path = "D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\revision 2\\final_inclusion.xlsx")



subscale_vargroups <- c("bathing","dressing","eating","toileting","indoormoving", "continence", 
                         
                         "neighbour","laundry", "cooking","carry5kg", "walk1km",  "crouch", "shopping",  "e14",
                         
                         "calculation_binary","orientation_binary", "registration_binary", "recall_binary", "language_binary")
```

```{r population characteristics by subscales}
adl_items$id = as.factor(adl_items$id)
mmse_baseline$id = as.factor(mmse_baseline$id)
mmse_baseline[c("id", "calculation","orientation", "registration", "recall", "language")] -> mmse_baseline

r2.inclu %>% #left_join(adl_items, by = 'id') %>%
             #left_join(mmse_baseline, by = 'id') %>%
             mutate(orientation_binary = ifelse(orientation >= median(orientation), "better", "worse"),
                    registration_binary = ifelse(registration >= median(registration), "better", "worse"),
                    calculation_binary = ifelse(calculation >= median(calculation), "better", "worse"),
                    recall_binary = ifelse(recall >= median(recall), "better", "worse"),
                    language_binary = ifelse(language >= median(language), "better", "worse"))-> r2.inclu


table1(~ bathing + dressing+eating+toileting+indoormoving+continence+
                         
                         as.factor(neighbour)+as.factor(laundry)+as.factor(cooking)+as.factor(carry5kg)+as.factor(walk1km)+ as.factor(crouch)+as.factor(shopping)+ as.factor(e14)+
                         
                         calculation_binary+orientation_binary+registration_binary+recall_binary+language_binary|inclexcl, r2.inclu)
```


```{r}
HW1_CMA_full %>% filter(id %in% r2.inclu.id$id) ->test

HW1_CMA_full %>% filter(!id %in% r2.inclu.id$id) -> not.incl
```



```{r revision 3 social and mental factor - distribution}

library(table1)

r2.inclu = inclexcl_criteria_2 %>% filter(!inclexcl %in% c('step 0：age<65',
                                                         'step 1: few missing',
                                                         'step 2: exclude loss-to-follow-up at 1st survey (11/12)'))
r2.inclu.id = r2.inclu %>% select(id)




social_network <- readRDS("E:/Linxin Liu/social_network.rds")

social_network %>% select(id, f111.code, f112.code, f113.code) -> social.items


addItems = function(df){

  df %>% #left_join(adl_items, by = 'id') -> df
         left_join(social.items, by = 'id') -> df

  return(df)
}

addItems(r2.inclu) -> r2.inclu


table1(~# mental well-being indicator          
         satisfaction_2 + personality_2 +
            # social participation and network #low.invol.act +
          involvement_tertiles + network.interact +
          f111.code + f112.code + f113.code|inclexcl, r2.inclu)  #-> social.mental.distribution

library(writexl)

## write sex specific table
write_xlsx(as.data.frame(social.mental.distribution), path = "E:\\DiXi\\heat vulnerability\\using threshold 5 years prior to exposure\\revision 3\\population characteristics\\population_characteristics_mental_social.xlsx")

```


```{r mental well being and cognitive functions}

table1(~ mmse.status.baseline + adl.status + iadl_3        
         #satisfaction_2 + personality_2 +
            # social participation and network #low.invol.act +
          , subset(r2.inclu,r2.inclu$satisfaction_2 =="missing")) ->  satisfaction_mmse

write_xlsx(as.data.frame(satisfaction_mmse), path = "E:\\DiXi\\heat vulnerability\\using threshold 5 years prior to exposure\\revision 3\\population characteristics\\satisfaction_mmse.xlsx")


table1(~ mmse.status.baseline + adl.status + iadl_3        
         #satisfaction_2 + personality_2 +
            # social participation and network #low.invol.act +
          , subset(r2.inclu,r2.inclu$personality_2 =="missing")) ->  personality_mmse

write_xlsx(as.data.frame(personality_mmse), path = "E:\\DiXi\\heat vulnerability\\using threshold 5 years prior to exposure\\revision 3\\population characteristics\\personality_mmse.xlsx")
```

```{r social isolation and living alone}

table1(~ mmse.status.baseline + adl.status + iadl_3 |co.resi.baseline, 
       
       subset(r2.inclu,r2.inclu$co.resi.baseline =="alone")) -> live_alone_adl

write_xlsx(as.data.frame(live_alone_adl), path = "E:\\DiXi\\heat vulnerability\\using threshold 5 years prior to exposure\\revision 3\\population characteristics\\live_alone_adl.xlsx")
```




#######################################################################
############################ exposure ############################
#######################################################################

######### import ####

```{r}
# HW1_CMA_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW1_CMA_full.rds")
# 
# HW2_WMO_90TH_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW2_WMO_90TH_1D_full.rds")
# 
# HW3_WMO_90TH_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW3_WMO_90TH_2D_full.rds")
# 
# HW4_WMO_90TH_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW4_WMO_90TH_3D_full.rds")
# 
# HW5_WMO_95TH_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW5_WMO_95TH_1D_full.rds")

HW6_WMO_95TH_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW6_WMO_95TH_2D_full.rds")

HW7_WMO_95TH_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW7_WMO_95TH_3D_full.rds")

HW8_NOAA_10C_1D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW8_NOAA_10C_1D_full.rds")

HW9_NOAA_10C_2D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW9_NOAA_10C_2D_full.rds")

# HW10_NOAA_10C_3D_full <- readRDS("E:\\DiXi\\heat vulnerability\\HW10_NOAA_10C_3D_full.rds")
```



```{r}
social_network <- readRDS("E:/Linxin Liu/social_network.rds")

social_network %>% select(id, f111.code, f112.code, f113.code) -> social.items


addItems = function(df){

  df %>% #left_join(adl_items, by = 'id') -> df
         left_join(social.items, by = 'id') -> df

  return(df)
}

# addItems(HW1_CMA_full) -> HW1_CMA_full
# addItems(HW2_WMO_90TH_1D_full) -> HW2_WMO_90TH_1D_full
# addItems(HW3_WMO_90TH_2D_full) -> HW3_WMO_90TH_2D_full
# addItems(HW4_WMO_90TH_3D_full) -> HW4_WMO_90TH_3D_full
# addItems(HW5_WMO_95TH_1D_full) -> HW5_WMO_95TH_1D_full
addItems(HW6_WMO_95TH_2D_full) -> HW6_WMO_95TH_2D_full
addItems(HW7_WMO_95TH_3D_full) -> HW7_WMO_95TH_3D_full
addItems(HW8_NOAA_10C_1D_full) -> HW8_NOAA_10C_1D_full
addItems(HW9_NOAA_10C_2D_full) -> HW9_NOAA_10C_2D_full
# addItems(HW10_NOAA_10C_3D_full) -> HW10_NOAA_10C_3D_full

```

```{r update iadl}
# updateIADL = function(df){
# 
#   df$iadl_3 = NA
#   df$iadl_3[which(df$iadl.score == 8)] = 'Full function'
#   df$iadl_3[which(df$iadl.score >= 9 & df$iadl.score <=16)] = 'Moderate impairment'
#   df$iadl_3[which(df$iadl.score >= 17 & df$iadl.score <=24)] = 'Severe impairment'
# 
#   return(df)
# }
# 
# 
# updateIADL(HW1_CMA_full) -> HW1_CMA_full
# updateIADL(HW2_WMO_90TH_1D_full) -> HW2_WMO_90TH_1D_full
# updateIADL(HW3_WMO_90TH_2D_full) -> HW3_WMO_90TH_2D_full
# updateIADL(HW4_WMO_90TH_3D_full) -> HW4_WMO_90TH_3D_full
# updateIADL(HW5_WMO_95TH_1D_full) -> HW5_WMO_95TH_1D_full
# updateIADL(HW6_WMO_95TH_2D_full) -> HW6_WMO_95TH_2D_full
# updateIADL(HW7_WMO_95TH_3D_full) -> HW7_WMO_95TH_3D_full
# updateIADL(HW8_NOAA_10C_1D_full) -> HW8_NOAA_10C_1D_full
# updateIADL(HW9_NOAA_10C_2D_full) -> HW9_NOAA_10C_2D_full
# updateIADL(HW10_NOAA_10C_3D_full) -> HW10_NOAA_10C_3D_full

updatechr = function(df){

  df$sex2 = as.character(df$sex)
  df$co.resi.baseline = as.character(df$co.resi.baseline)
  df$marital.baseline = as.character(df$marital.baseline)
  df$d71 = as.character(df$d71)
  df$d81 = as.character(df$d81)
  df$involvement_tertiles2 = as.character(df$involvement_tertiles)
  
  # df$bathing = as.character(df$bathing)
  # df$dressing = as.character(df$dressing)
  # df$eating = as.character(df$eating)
  # df$indoormoving = as.character(df$indoormoving)
  # df$continence = as.character(df$continence)
  
  df$neighbour = as.character(df$neighbour)
  df$laundry = as.character(df$laundry)
  df$cooking = as.character(df$cooking)
  df$carry5kg = as.character(df$carry5kg)
  df$walk1km = as.character(df$walk1km)
  df$crouch = as.character(df$crouch)
  df$shopping = as.character(df$shopping)
  df$e14 = as.character(df$e14)
  
  # df$calculation_binary = as.character(df$calculation_binary)
  # df$orientation_binary = as.character(df$orientation_binary)
  # df$registration_binary = as.character(df$registration_binary)
  # df$recall_binary = as.character(df$recall_binary)
  # df$language_binary = as.character(df$language_binary)

  return(df)
}

updatechr(HW1_CMA_full) -> HW1_CMA_full
updatechr(HW2_WMO_90TH_1D_full) -> HW2_WMO_90TH_1D_full
updatechr(HW3_WMO_90TH_2D_full) -> HW3_WMO_90TH_2D_full
updatechr(HW4_WMO_90TH_3D_full) -> HW4_WMO_90TH_3D_full
updatechr(HW5_WMO_95TH_1D_full) -> HW5_WMO_95TH_1D_full
updatechr(HW6_WMO_95TH_2D_full) -> HW6_WMO_95TH_2D_full
updatechr(HW7_WMO_95TH_3D_full) -> HW7_WMO_95TH_3D_full
updatechr(HW8_NOAA_10C_1D_full) -> HW8_NOAA_10C_1D_full
updatechr(HW9_NOAA_10C_2D_full) -> HW9_NOAA_10C_2D_full
updatechr(HW10_NOAA_10C_3D_full) -> HW10_NOAA_10C_3D_full


```



```{r heat wave days full sample}
adl.na.id = as.factor(inclexcl_criteria_2$id[which(is.na(inclexcl_criteria_2$adl.status))])

nhw_fun <- function(dataset,x,def) {
  
  #dataset %>% filter(! id %in% adl.na.id) -> dataset
  
  counts = length(unique(dataset$id))
  dataset %>% dplyr::group_by(!!rlang::sym(x)) %>% dplyr::summarise(
    n = n_distinct(id),
    proportion = n/counts,
    nHW = round(sum(hwd.ind)/(n()/365.25),1)
  ) %>% 
    rename(var=!!rlang::sym(x)) %>%
  mutate(definition = def, group=x)
         }

vargroups <- c("agegroup","sex2","co.resi.baseline","UorR","marital.baseline", 
               
               "education","occupation", "d71", "d81",
               
               "adl.status","iadl_3", "mmse.status.baseline")



library(dplyr)

# nhw_fun(HW1_CMA_full,"agegroup","hw1")
setwd('D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\revision 2\\strata prov\\population characteristics')

nhw_1 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW1_CMA_full,def="hw1"))
nhw_2 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW2_WMO_90TH_1D_full,def="hw2"))
nhw_3 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW3_WMO_90TH_2D_full,def="hw3"))
nhw_4 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW4_WMO_90TH_3D_full,def="hw4"))
nhw_5 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW5_WMO_95TH_1D_full,def="hw5"))
nhw_6 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW6_WMO_95TH_2D_full,def="hw6"))
nhw_7 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW7_WMO_95TH_3D_full,def="hw7"))
nhw_8 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW8_NOAA_10C_1D_full,def="hw8"))
nhw_9 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW9_NOAA_10C_2D_full,def="hw9"))
nhw_10 <- bind_rows(lapply(vargroups,nhw_fun,dataset=HW10_NOAA_10C_3D_full,def="hw10"))

nhw_result <- bind_cols(nhw_1,nhw_2,nhw_3,nhw_4,nhw_5,nhw_6,nhw_7,nhw_8,nhw_9,nhw_10,.id="var")
write.csv(nhw_result,file="nhw_var subgroup.csv")
       
      

```



```{r}
subscale_vargroups <- c("bathing","dressing","eating","toileting","indoormoving", "continence", 
                         
                         "neighbour","laundry", "cooking","carry5kg", "walk1km",  "crouch", "shopping",  "e14",
                         
                         "calculation_binary","orientation_binary", "registration_binary", "recall_binary", "language_binary")



library(dplyr)

# nhw_fun(HW1_CMA_full,"agegroup","hw1")
setwd('E:\\DiXi\\heat vulnerability\\using threshold 5 years prior to exposure\\revision 2\\strata prov\\population characteristics')

sub_nhw_1 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW1_CMA_full,def="hw1"))
sub_nhw_2 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW2_WMO_90TH_1D_full,def="hw2"))
sub_nhw_3 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW3_WMO_90TH_2D_full,def="hw3"))
sub_nhw_4 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW4_WMO_90TH_3D_full,def="hw4"))
sub_nhw_5 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW5_WMO_95TH_1D_full,def="hw5"))
sub_nhw_6 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW6_WMO_95TH_2D_full,def="hw6"))
sub_nhw_7 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW7_WMO_95TH_3D_full,def="hw7"))
sub_nhw_8 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW8_NOAA_10C_1D_full,def="hw8"))
sub_nhw_9 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW9_NOAA_10C_2D_full,def="hw9"))
sub_nhw_10 <- bind_rows(lapply(subscale_vargroups,nhw_fun,dataset=HW10_NOAA_10C_3D_full,def="hw10"))

sub_nhw_result <- bind_cols(sub_nhw_1,sub_nhw_2,sub_nhw_3,sub_nhw_4,sub_nhw_5,
                        sub_nhw_6,sub_nhw_7,sub_nhw_8,sub_nhw_9,sub_nhw_10,.id="var")

write.csv(sub_nhw_result,file="sub_nhw_var subgroup.csv")


```



```{r exposure characteristics of }
social_mental_vargroups <- c('satisfaction_2', 'personality_2', 
                              'involvement_tertiles2', 'network.interact',
                              'f111.code', 'f112.code', 'f113.code')



library(dplyr)

# nhw_fun(HW1_CMA_full,"agegroup","hw1")
setwd('E:\\DiXi\\heat vulnerability\\using threshold 5 years prior to exposure\\revision 3\\population characteristics')

# sub_nhw_1 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW1_CMA_full,def="hw1"))
# sub_nhw_2 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW2_WMO_90TH_1D_full,def="hw2"))
# sub_nhw_3 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW3_WMO_90TH_2D_full,def="hw3"))
# sub_nhw_4 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW4_WMO_90TH_3D_full,def="hw4"))
# sub_nhw_5 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW5_WMO_95TH_1D_full,def="hw5"))
sub_nhw_6 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW6_WMO_95TH_2D_full,def="hw6"))
sub_nhw_7 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW7_WMO_95TH_3D_full,def="hw7"))
sub_nhw_8 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW8_NOAA_10C_1D_full,def="hw8"))
sub_nhw_9 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW9_NOAA_10C_2D_full,def="hw9"))
sub_nhw_10 <- bind_rows(lapply(social_mental_vargroups,nhw_fun,dataset=HW10_NOAA_10C_3D_full,def="hw10"))

nhw_result <- bind_cols(sub_nhw_1,sub_nhw_2,sub_nhw_3,sub_nhw_4,sub_nhw_5,
                        sub_nhw_6,sub_nhw_7,sub_nhw_8,sub_nhw_9,sub_nhw_10,.id="var")

write.csv(nhw_result,file="social_mental_nhw_var subgroup.csv")


```





```{r format sub_nhw_Var}
sub_nhw_var.subgroup_clean <- read.csv("E:/DiXi/heat vulnerability/using threshold 5 years prior to exposure/revision 2/strata prov/population characteristics/sub_nhw_var subgroup_clean.csv")
head(sub_nhw_var.subgroup_clean)

sub_nhw_var.subgroup_clean %>% mutate(n.prop = paste0(n,' (', round(percent*100, 1), '%)')) -> sub_nhw_var.subgroup_clean

setwd('E:\\DiXi\\heat vulnerability\\using threshold 5 years prior to exposure\\revision 2\\strata prov\\population characteristics')
write.csv(sub_nhw_var.subgroup_clean,file="sub_nhw_var_subgroup_2.csv")

```



```{r merge cities}
#social_network %>% select(id, f111.code, f112.code, f113.code) -> social.items


add.city = function(df){
  
  df %>% left_join(GDP_pop_2008_sel, by = 'id') -> df
         #left_join(social.items, by = 'id') -> df
  
  return(df)
}

add.city(HW1_CMA_full) -> HW1_CMA_full
add.city(HW2_WMO_90TH_1D_full) -> HW2_WMO_90TH_1D_full
add.city(HW3_WMO_90TH_2D_full) -> HW3_WMO_90TH_2D_full
add.city(HW4_WMO_90TH_3D_full) -> HW4_WMO_90TH_3D_full
add.city(HW5_WMO_95TH_1D_full) -> HW5_WMO_95TH_1D_full
add.city(HW6_WMO_95TH_2D_full) -> HW6_WMO_95TH_2D_full
add.city(HW7_WMO_95TH_3D_full) -> HW7_WMO_95TH_3D_full
add.city(HW8_NOAA_10C_1D_full) -> HW8_NOAA_10C_1D_full
add.city(HW9_NOAA_10C_2D_full) -> HW9_NOAA_10C_2D_full
add.city(HW10_NOAA_10C_3D_full) -> HW10_NOAA_10C_3D_full


add.city(r2.inclu) -> r2.inclu
```

```{r region correction}
correct.region = function(df) {
      # divide them into 7 geographical regions (administrative definition) ## note that there are wrong pinyin in the dataset: heilongjiang ->helongjiang; tianjin->tianjing, shandong ->shangdong
      df %>% mutate(region = case_when(
      
      # east china
      prov %in% c('shangdong', 'jiangsu', 'anhui', 'zhejiang', 'fujian', 'shanghai', 'jiangxi') ~ 'east_china',
      # north china
      prov %in% c('beijing', 'tianjing', 'hebei', 'shanxi', 'neimenggu') ~ 'north_china',
      # north east
      prov %in% c('liaoning', 'jilin', 'helongjiang') ~ 'north_east',
      # mid China
      prov %in% c('henan', 'hubei', 'hunan') ~ 'mid_china',
      # south China
      prov %in% c('guangdong', 'guangxi', 'hainan' )~ 'south_china',
      # north west
      prov %in% c('shaanxi') ~ 'north_west',
      # south west
      prov %in% c('chongqing', 'sichuan') ~ 'south_west'
      
      
      )) -> df
  
    return(df) 
}


correct.region(r2.inclu) -> r2.inclu
```


```{r}
library(lubridate)
colnames(r2.inclu)
head(r2.inclu)

##### ---------- city ---------- ########
length(unique(r2.inclu$city2))

r2.inclu %>% group_by(city2) %>% summarise(n = n(),
                                           total.time = sum(times)) -> des.city.full

r2.inclu %>% filter(month(dend) %in% c(5:9) & final_status == 'death') %>%
             group_by(city2) %>% summarise(n.summer.death = n(),  total.time = sum(times)) -> des.city.death

summary(des.city.death);summary(des.city.full)

##### ---------- province ---------- ########
r2.inclu %>% group_by(prov) %>% summarise(n = n(),
                                           total.time = sum(times)) -> des.province.full

r2.inclu %>% filter(month(dend) %in% c(5:9) & final_status == 'death') %>%
             group_by(prov) %>% summarise(n.summer.death = n()) -> des.province.death

summary(des.province.death);summary(des.province.full)

#### ---------- region ---------- ########
r2.inclu %>% group_by(region) %>% summarise(n = n(),
                                           total.time = sum(times)) -> des.region.full

r2.inclu %>% filter(month(dend) %in% c(5:9) & final_status == 'death') %>%
             group_by(region) %>% summarise(n.summer.death = n()) -> des.region.death

summary(des.region.death);summary(des.region.full)
```




```{r  exposure charactier by city and province}
nhw_geo <- function(dataset,x,def) {
  
  dataset %>% dplyr::group_by(!!rlang::sym(x)) %>% dplyr::summarise(


    nHW = round(sum(hwd.ind)/(n()/365.25),1)
  ) %>% 
    rename(var=!!rlang::sym(x)) %>%
  mutate(definition = def, group=x)
         }

vargroups <- c('city2', 'prov')


nhw_geo_1 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW1_CMA_full,def="hw1"))
nhw_geo_2 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW2_WMO_90TH_1D_full,def="hw2"))
nhw_geo_3 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW3_WMO_90TH_2D_full,def="hw3"))
nhw_geo_4 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW4_WMO_90TH_3D_full,def="hw4"))
nhw_geo_5 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW5_WMO_95TH_1D_full,def="hw5"))
nhw_geo_6 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW6_WMO_95TH_2D_full,def="hw6"))
nhw_geo_7 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW7_WMO_95TH_3D_full,def="hw7"))
nhw_geo_8 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW8_NOAA_10C_1D_full,def="hw8"))
nhw_geo_9 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW9_NOAA_10C_2D_full,def="hw9"))
nhw_geo_10 <- bind_rows(lapply(vargroups,nhw_geo,dataset=HW10_NOAA_10C_3D_full,def="hw10"))

nhw_result_geo <- bind_rows(nhw_geo_1,nhw_geo_2,nhw_geo_3,nhw_geo_4,nhw_geo_5,nhw_geo_6,nhw_geo_7,nhw_geo_8,nhw_geo_9,nhw_geo_10,.id="var")

saveRDS(nhw_result_geo, 'nhw_result_geo.rds')
summary(nhw_geo_1)
hist(nhw_geo_1$nHW)
```




```{r summarise exposure characteristics}
# nhw_result_geo %>% filter(definition == 'hw1' & group == 'city2') %>% summarise(min = min(nHW),
#                                                                                 Q1 = quantile(nHW, 0.25),
#                                                                                 median = median(nHW),
#                                                                                 mean = mean(nHW),
#                                                                                 Q3 = quantile(nHW, 0.75),
#                                                                                 max = max(nHW)) -> des.nhw

get.des.nhw = function(def, group.scale){
  
  nhw_result_geo %>% filter(definition == def & group == group.scale) %>% summarise(min = min(nHW),
                                                                                Q1 = quantile(nHW, 0.25),
                                                                                median = median(nHW),
                                                                                mean = mean(nHW),
                                                                                Q3 = quantile(nHW, 0.75),
                                                                                max = max(nHW)) -> des.nhw
  
  return(des.nhw)
}

### CITY ###
des.nhw.city.1 = get.des.nhw('hw1', 'city2'); 
des.nhw.city.2 = get.des.nhw('hw2', 'city2'); des.nhw.city.3 = get.des.nhw('hw3', 'city2'); des.nhw.city.4 = get.des.nhw('hw4', 'city2'); 
des.nhw.city.5 = get.des.nhw('hw5', 'city2'); des.nhw.city.6 = get.des.nhw('hw6', 'city2'); des.nhw.city.7 = get.des.nhw('hw7', 'city2'); 
des.nhw.city.8 = get.des.nhw('hw8', 'city2'); des.nhw.city.9 = get.des.nhw('hw9', 'city2'); des.nhw.city.10 = get.des.nhw('hw10', 'city2')

des.nhw.city = rbind(des.nhw.city.1, des.nhw.city.2, des.nhw.city.3, des.nhw.city.4, des.nhw.city.5, 
                     des.nhw.city.6, des.nhw.city.7, des.nhw.city.8, des.nhw.city.9, des.nhw.city.10)

write_xlsx(des.nhw.city, path = "D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\revision 2\\strata prov\\population characteristics\\des.nhw.city.xlsx")

#### PROVINCE ###
des.nhw.prov.1 = get.des.nhw('hw1', 'prov'); 
des.nhw.prov.2 = get.des.nhw('hw2', 'prov'); des.nhw.prov.3 = get.des.nhw('hw3', 'prov'); des.nhw.prov.4 = get.des.nhw('hw4', 'prov'); 
des.nhw.prov.5 = get.des.nhw('hw5', 'prov'); des.nhw.prov.6 = get.des.nhw('hw6', 'prov'); des.nhw.prov.7 = get.des.nhw('hw7', 'prov'); 
des.nhw.prov.8 = get.des.nhw('hw8', 'prov'); des.nhw.prov.9 = get.des.nhw('hw9', 'prov'); des.nhw.prov.10 = get.des.nhw('hw10', 'prov')

des.nhw.prov = rbind(des.nhw.prov.1, des.nhw.prov.2, des.nhw.prov.3, des.nhw.prov.4, des.nhw.prov.5, 
                     des.nhw.prov.6, des.nhw.prov.7, des.nhw.prov.8, des.nhw.prov.9, des.nhw.prov.10)

write_xlsx(des.nhw.prov, path = "D:\\DiXi\\data preparation\\environmental info\\single events identification\\heat and cold\\using threshold 5 years prior to exposure\\revision 2\\strata prov\\population characteristics\\des.nhw.prov.xlsx")

```

```{r total follow-up years}
HW1_CMA_full %>% filter(id %in% r2.inclu$id) %>% summarise(n.id = n_distinct(id), total.fu.years = n()/(365.25))
```