---
title: "Fully adjust all betas"
output: html_document
date: "2023-10-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r iadl.status update}
# def = inclexcl_criteria
# def$iadl_3 = NA
# def$iadl_3[which(def$iadl.score == 8)] = 'Full function'
# def$iadl_3[which(def$iadl.score >= 9 & def$iadl.score <=16)] = 'Moderate impairment'
# def$iadl_3[which(def$iadl.score >= 17 & def$iadl.score <=24)] = 'Severe impairment'
# table(def$iadl_3, useNA = 'ifany')

updateIADL = function(df){

  df$iadl_3 = NA
  df$iadl_3[which(df$iadl.score == 8)] = 'Full function'
  df$iadl_3[which(df$iadl.score >= 9 & df$iadl.score <=16)] = 'Moderate impairment'
  df$iadl_3[which(df$iadl.score >= 17 & df$iadl.score <=24)] = 'Severe impairment'

  return(df)
}

updateIADL(HW1_CMA_full) -> HW1_CMA_full
updateIADL(HW2_WMO_90TH_1D_full) -> HW2_WMO_90TH_1D_full
updateIADL(HW3_WMO_90TH_2D_full) -> HW3_WMO_90TH_2D_full
updateIADL(HW4_WMO_90TH_3D_full) -> HW4_WMO_90TH_3D_full
updateIADL(HW5_WMO_95TH_1D_full) -> HW5_WMO_95TH_1D_full
updateIADL(HW6_WMO_95TH_2D_full) -> HW6_WMO_95TH_2D_full
updateIADL(HW7_WMO_95TH_3D_full) -> HW7_WMO_95TH_3D_full
updateIADL(HW8_NOAA_10C_1D_full) -> HW8_NOAA_10C_1D_full
updateIADL(HW9_NOAA_10C_2D_full) -> HW9_NOAA_10C_2D_full
updateIADL(HW10_NOAA_10C_3D_full) -> HW10_NOAA_10C_3D_full



```

############# Model 7 fully adjusted with all betas #########
```{r fully adjusted model, all envi}
getFullyAdjustedHW = function(dataset, file_name){

    mod = coxph(Surv(tstart, times, event.death) ~
                  # exposure and environmental covariates
                  hwd.ind + pm25.scale + ndvi.scale + rh.scale +
                  # demographical factors
                  trueage + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
                  # physical logical disorder and cognitive disorder
                  adl.status + mmse.status.baseline + iadl_3 +
                  # mental health and personality
                  satisfaction_2 + personality_2+
                  # life style
                  fruit + veg + tea + d71 + d81 + d91 +
                  # social participation and network #low.invol.act +
                  involvement_tertiles + network.interact +
                  #strata(prov) + cluster(clusters),
                  strata(prov) + cluster(id), data = dataset)


    mod %>% tidy(conf.int = TRUE, exponentiate = TRUE) -> result

    result %>% select(term, estimate, conf.low, conf.high, p.value)  %>%
               summarise(term = term,
                         HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                         p = round(p.value,4)) -> result

    write.csv(result, paste0(file_name, '_model all betas.csv'))

}


setwd("D:/DiXi/data preparation/environmental info/single events identification/heat and cold/using threshold 5 years prior to exposure/revision 2/strata prov/all betas")

getFullyAdjustedHW(HW1_CMA_full, 'HW1')
getFullyAdjustedHW(HW2_WMO_90TH_1D_full, 'HW2')
getFullyAdjustedHW(HW3_WMO_90TH_2D_full, 'HW3')
getFullyAdjustedHW(HW4_WMO_90TH_3D_full, 'HW4')
getFullyAdjustedHW(HW5_WMO_95TH_1D_full, 'HW5')
getFullyAdjustedHW(HW6_WMO_95TH_2D_full, 'HW6')
getFullyAdjustedHW(HW7_WMO_95TH_3D_full, 'HW7')
getFullyAdjustedHW(HW8_NOAA_10C_1D_full, 'HW8')
getFullyAdjustedHW(HW9_NOAA_10C_2D_full, 'HW9')
getFullyAdjustedHW(HW10_NOAA_10C_3D_full, 'HW10')

```


```{r fully adjusted model, no envi}
getFullyAdjustedHW2 = function(dataset, file_name){

    mod = coxph(Surv(tstart, times, event.death) ~
                  # exposure and environmental covariates (not adjusted)
                  hwd.ind + 
                  # demographical factors
                  trueage + sex + UorR + co.resi.baseline + education + occupation + marital.baseline +
                  # physical logical disorder and cognitive disorder
                  adl.status + mmse.status.baseline + iadl_3 +
                  # mental health and personality
                  # satisfaction_2 + personality_2+
                  # life style
                  # fruit + veg + tea + d71 + d81 + d91 +
                  # smoking and drinking
                  d71 + d81 +
                  # social participation and network #low.invol.act +
                  # involvement_tertiles + network.interact +
                  #strata(prov) + cluster(clusters),
                  strata(prov) + cluster(id), data = dataset)


    mod %>% tidy(conf.int = TRUE, exponentiate = TRUE) -> result

    result %>% select(term, estimate, conf.low, conf.high, p.value)  %>%
               summarise(term = term,
                         HR = paste0(round(estimate, 2), ' (', round(conf.low, 2), ',', round(conf.high, 2), ')'),
                         p = round(p.value,4)) -> result

    write.csv(result, paste0(file_name, '_all beta without envi.csv'))

}


setwd("D:/DiXi/data preparation/environmental info/single events identification/heat and cold/using threshold 5 years prior to exposure/revision 2/strata prov/all betas")

# getFullyAdjustedHW2(HW1_CMA_full, 'HW1')
# getFullyAdjustedHW2(HW2_WMO_90TH_1D_full, 'HW2')
# getFullyAdjustedHW2(HW3_WMO_90TH_2D_full, 'HW3')
# getFullyAdjustedHW2(HW4_WMO_90TH_3D_full, 'HW4')
# getFullyAdjustedHW2(HW5_WMO_95TH_1D_full, 'HW5')
# getFullyAdjustedHW2(HW6_WMO_95TH_2D_full, 'HW6')
# getFullyAdjustedHW2(HW7_WMO_95TH_3D_full, 'HW7')
# getFullyAdjustedHW2(HW8_NOAA_10C_1D_full, 'HW8')
# getFullyAdjustedHW2(HW9_NOAA_10C_2D_full, 'HW9')
# getFullyAdjustedHW2(HW10_NOAA_10C_3D_full, 'HW10')



# combineResults(paste0(directory_path, '\\model envi\\fully adjusted without rh'), '', 'HW model fully adjusted without rh.csv')


```


```{r combine}
# install.packages("openxlsx")
library(openxlsx)
getwd()
csv_files <- c("HW1_all beta without envi.csv", "HW2_all beta without envi.csv", "HW3_all beta without envi.csv",
               "HW4_all beta without envi.csv", "HW5_all beta without envi.csv", "HW6_all beta without envi.csv",
               "HW7_all beta without envi.csv", "HW8_all beta without envi.csv", "HW9_all beta without envi.csv",
               "HW10_all beta without envi.csv")
wb <- createWorkbook()
for (i in 1:length(csv_files)) {
  sheet_name <- sub(".csv", "", csv_files[i])  # Use the CSV file name as the sheet name
  df <- read.csv(csv_files[i])
  addWorksheet(wb, sheet_name)
  writeData(wb, sheet = sheet_name, x = df)
}

saveWorkbook(wb, "HW_all beta without envi.xlsx")


csv_files2 <- c("HW1_all beta without envi.csv", "HW2_all beta without envi.csv", "HW3_all beta without envi.csv",
               "HW4_all beta without envi.csv", "HW5_all beta without envi.csv", "HW6_all beta without envi.csv",
               "HW7_all beta without envi.csv", "HW8_all beta without envi.csv", "HW9_all beta without envi.csv",
               "HW10_all beta without envi.csv")
wb2 <- createWorkbook()
for (i in 1:length(csv_files2)) {
  sheet_name <- sub(".csv", "", csv_files2[i])  # Use the CSV file name as the sheet name
  df <- read.csv(csv_files2[i])
  addWorksheet(wb2, sheet_name)
  writeData(wb2, sheet = sheet_name, x = df)
}

saveWorkbook(wb2, "HW_all beta without envi.xlsx")

```
